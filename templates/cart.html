<!doctype html>
<html class="no-js" lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Cart || Jantrik Bootstrap5 Template for Tools, Equipment Store</title>
    <meta name="description" content="Default Description">
    <meta name="keywords" content="E-commerce" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Google Font css -->
    <link href="https://fonts.googleapis.com/css?family=Lily+Script+One" rel="stylesheet"> 

    <!-- mobile menu css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/meanmenu.min.css') }}">
    <!-- animate css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}">
    <!-- nivo slider css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nivo-slider.css') }}">
    <!-- owl carousel css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.carousel.min.css') }}">
    <!-- slick css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/slick.css') }}">
    <!-- price slider css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui.min.css') }}">
    <!-- fontawesome css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
    <!-- fancybox css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.fancybox.css') }}">
    <!-- bootstrap css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <!-- default css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/default.css') }}">
    <!-- style css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- responsive css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">

    <!-- modernizr js -->
    <script src="{{ url_for('static', filename='js/vendor/modernizr-2.8.3.min.js') }}"></script>
</head>

<body>
    <!-- Header Area Start -->
    <header>
        <!-- Header content (navigation, logo, etc.) goes here -->
    </header>
    <!-- Header Area End -->

    <!-- Breadcrumb Start -->
    <div class="breadcrumb-area pt-60 pb-55 pt-sm-30 pb-sm-20">
        <div class="container">
            <div class="breadcrumb">
                <ul>
                    <li><a href="/index">Home</a></li>
                    <li class="active"><a href="/cart">Cart</a></li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Cart Main Area Start -->
    <div class="cart-main-area pb-80 pb-sm-50">
        <div class="container">
           <h2 class="text-capitalize sub-heading">cart</h2>
            <div class="row">
                <div class="col-md-12">
                    <!-- Form Start -->
                    <form id="cart-form" action="#">
                        <!-- Table Content Start -->
                        <div class="table-content table-responsive mb-50">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="product-thumbnail">Image</th>
                                        <th class="product-name">Product</th>
                                        <th class="product-price">Price</th>
                                        <th class="product-quantity">Quantity</th>
                                        <th class="product-subtotal">Total</th>
                                        <th class="product-remove">Remove</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in cart_items %}
                                    <tr data-product-id="{{ item.product_id }}">
                                        <td class="product-thumbnail">
                                            <a href="#"><img src="{{ item.product_image }}" alt="cart-image" /></a>
                                        </td>
                                        <td class="product-name"><a href="#">{{ item.product_name }}</a></td>
                                        <td class="product-price"><span class="amount" id="price_{{ item.product_id }}">£{{ item.product_price }}</span></td>
                                        <td class="product-quantity">
                                            <div class="quantity-wrapper">
                                                <button type="button" onclick="decrementQuantity('{{ item.product_id }}')">-</button>
                                                <input type="number" id="quantity_{{ item.product_id }}" name="quantity" class="quantity" value="{{ item.product_quantity }}" min="1" max="100" onchange="updatePrice('{{ item.product_id }}')" />
                                                <button type="button" onclick="incrementQuantity('{{ item.product_id }}')">+</button>
                                            </div>
                                        </td>
                                        <td class="product-subtotal">£<span id="total_{{ item.product_id }}">{{ item.total_price }}</span></td>
                                        <td class="product-remove">
                                            <button onclick="removeFromCart('{{ item.product_id }}')">
                                                <i class="fa fa-times" aria-hidden="true"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Table Content End -->
                    
                        <!-- Cart Buttons Start -->
                        <div class="row">
                            <div class="col-lg-8 col-md-7">
                                <div class="buttons-cart">
                                    <input type="submit" value="Update Cart" />
                                    <a href="#">Continue Shopping</a>
                                </div>
                            </div>
                            <!-- Cart Totals Start -->
                            <div class="col-lg-4 col-md-12">
                                <div class="cart_totals">
                                    <h2>Cart Totals</h2>
                                    <br />
                                    <table>
                                        <tbody>
                                            <tr class="order-total">
                                                <th>Total</th>
                                                <td>
                                                    <strong><span class="amount" id="cart_total">£0.00</span></strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="wc-proceed-to-checkout">
                                        <a href="#">Proceed to Checkout</a>
                                    </div>
                                </div>
                            </div>
                            <!-- Cart Totals End -->
                        </div>
                        <!-- Row End -->
                    </form>
                    <!-- Form End -->
                    </div>
                    </div>
                    <!-- Row End -->
                    </div>
                    </div>
                    <!-- Cart Main Area End -->
                    
                    <!-- Footer Start -->
                    <footer>
                        <!-- Footer content goes here -->
                    </footer>
                    <!-- Footer End -->
                        <!-- Include Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Include your Firebase configuration -->
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyB42nHmPcpj7BmOPPdO93lXqzA3PjjXZOc",
            authDomain: "project-dbebd.firebaseapp.com",
            projectId: "project-dbebd",
            storageBucket: "project-dbebd.appspot.com",
            messagingSenderId: "374516311348",
            appId: "1:374516311348:web:d916facf6720a4e275f161",
            databaseURL: "https://project-dbebd-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get a reference to the database service
        var database = firebase.database();

        // Function to update cart UI (you can implement this later)
        function updateCartUI(cartItems) {
            console.log('Updating cart UI with:', cartItems);
            // Implement your logic here to update the cart UI
        }

        // Listen for changes in the cart
        const userId = "{{ user_id }}"; // Make sure this is populated from your Flask template
        database.ref('/cart/' + userId).on('value', (snapshot) => {
            const cartItems = snapshot.val();
            updateCartUI(cartItems);
        });
    </script>
                    <!-- JavaScript -->
                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // Initial calculation of cart total
                            updateCartTotal();
                    
                            // Handle form submission
                            $('#cart-form').on('submit', function(event) {
                                event.preventDefault();
                                console.log('Form submitted');
                                updateCart();
                            });
                        });
                    
                        // Function to get the user's UID
                        function getUserId() {
                            return "{{ user_id }}";  // This will be populated from the Flask template
                        }
                    
                        // Update the price for a specific item
                        function updatePrice(itemKey) {
                            const quantityInput = document.getElementById('quantity_' + itemKey);
                            if (quantityInput) {
                                const quantity = parseInt(quantityInput.value);
                                const pricePerUnit = parseFloat(document.getElementById('price_' + itemKey).textContent.replace('£', ''));
                                const totalPrice = quantity * pricePerUnit;
                                document.getElementById('total_' + itemKey).textContent = '£' + totalPrice.toFixed(2);
                                updateCartTotal();
                                updateQuantityInBackend(itemKey, quantity);
                            } else {
                                console.error('Quantity input not found for item:', itemKey);
                            }
                        }
                    
                        // Increment the quantity of a specific item
                        function incrementQuantity(itemKey) {
                            const quantityInput = document.getElementById('quantity_' + itemKey);
                            if (quantityInput) {
                                let quantity = parseInt(quantityInput.value);
                                const maxQuantity = parseInt(quantityInput.getAttribute('max'));
                                if (quantity < maxQuantity) {
                                    quantity += 1;
                                    quantityInput.value = quantity;
                                    updatePrice(itemKey);
                                } else {
                                    console.log('Max quantity reached');
                                }
                            } else {
                                console.error('Quantity input not found for item:', itemKey);
                            }
                        }
                    
                        // Decrement the quantity of a specific item
                        function decrementQuantity(itemKey) {
                            const quantityInput = document.getElementById('quantity_' + itemKey);
                            if (quantityInput) {
                                let quantity = parseInt(quantityInput.value);
                                if (quantity > 1) {
                                    quantity -= 1;
                                    quantityInput.value = quantity;
                                    updatePrice(itemKey);
                                }
                            } else {
                                console.error('Quantity input not found for item:', itemKey);
                            }
                        }
                    
                        // Update the total price of the cart
                        function updateCartTotal() {
                            let totalElements = document.querySelectorAll('[id^="total_"]');
                            let cartTotal = 0;
                            totalElements.forEach(function(element) {
                                cartTotal += parseFloat(element.textContent.replace('£', ''));
                            });
                            document.getElementById('cart_total').textContent = '£' + cartTotal.toFixed(2);
                        }
                    
                        // Send updated quantity information to the backend
                        function updateQuantityInBackend(itemKey, quantity) {
                            const userId = getUserId();
                            if (!userId) {
                                alert('User ID is missing. Please log in again.');
                                return;
                            }

                            $.ajax({
                                url: '/update-cart',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    user_id: userId,
                                    cart: [{ product_id: itemKey, quantity: quantity }]
                                }),
                                success: function(response) {
                                    console.log('Quantity updated successfully', response);
                                    if (response.success) {
                                        $('#cart_total').text('£' + response.total.toFixed(2));
                                    }
                                },
                                error: function(jqXHR, textStatus, errorThrown) {
                                    console.error('Error updating quantity:', textStatus, errorThrown, jqXHR.responseText);
                                    alert('Error updating quantity. Please try again.');
                                }
                            });
                        }
                    
                        // Remove an item from the cart
                        function removeFromCart(itemKey) {
                            console.log('Attempting to remove item:', itemKey);
                            if (confirm('Are you sure you want to remove this item from your cart?')) {
                                $.ajax({
                                    url: '/remove-from-cart/' + itemKey,
                                    method: 'POST',
                                    success: function(response) {
                                        console.log('Server response:', response);
                                        if (response.success) {
                                            console.log('Item removed successfully');
                                            $('tr[data-product-id="' + itemKey + '"]').remove();
                                            updateCartTotal();
                                        } else {
                                            console.error('Failed to remove item:', response.message);
                                            alert('Failed to remove item: ' + response.message);
                                        }
                                    },
                                    error: function(jqXHR, textStatus, errorThrown) {
                                        console.error('Error removing item:', textStatus, errorThrown);
                                        console.error('Response text:', jqXHR.responseText);
                                        let errorMessage = 'Error removing item. ';
                                        try {
                                            let errorResponse = JSON.parse(jqXHR.responseText);
                                            errorMessage += errorResponse.message || '';
                                        } catch (e) {
                                            errorMessage += 'Please try again.';
                                        }
                                        alert(errorMessage);
                                    }
                                });
                            }
                        }
                    
                        // Update the cart with new data
                        function updateCart() {
                            const userId = getUserId();  // Get the user's UID
                            if (!userId) {
                                alert('User ID is missing. Please log in again.');
                                return;  // Exit the function or handle the error appropriately
                            }
                    
                            var cartData = [];
                            $('table tbody tr').each(function() {
                                var $row = $(this);
                                var productId = $row.data('product-id');
                                var quantity = $row.find('.quantity').val();
                                cartData.push({ product_id: productId, quantity: quantity });
                            });
                    
                            $.ajax({
                                url: '/update-cart',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ user_id: userId, cart: cartData }),
                                success: function(response) {
                                    if (response.success) {
                                        console.log('Cart updated successfully');
                                        updateCartTotal();
                                    }
                                },
                                error: function(jqXHR, textStatus, errorThrown) {
                                    console.error('Error updating cart:', textStatus, errorThrown, jqXHR.responseText);
                                }
                            });
                        }
                    </script>
                    
                    
    
    
    <!-- Additional Scripts -->
    <script src="{{ url_for('static', filename='js/vendor/jquery-1.12.4.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.meanmenu.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.scrollUp.js') }}"></script>
    <script src="{{ url_for('static', filename='js/owl.carousel.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/slick.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/wow.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.countdown.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.nivo.slider.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.fancybox.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/plugins.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>