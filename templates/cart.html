<!doctype html>
<html class="no-js" lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Cart || Jantrik Bootstrap5 Template for Tools, Equipment Store</title>
    <meta name="description" content="Default Description">
    <meta name="keywords" content="E-commerce" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Google Font css -->
    <link href="https://fonts.googleapis.com/css?family=Lily+Script+One" rel="stylesheet"> 

    <!-- mobile menu css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/meanmenu.min.css') }}">
    <!-- animate css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}">
    <!-- nivo slider css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nivo-slider.css') }}">
    <!-- owl carousel css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.carousel.min.css') }}">
    <!-- slick css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/slick.css') }}">
    <!-- price slider css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui.min.css') }}">
    <!-- fontawesome css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
    <!-- fancybox css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.fancybox.css') }}">
    <!-- bootstrap css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <!-- default css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/default.css') }}">
    <!-- style css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- responsive css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">

    <!-- modernizr js -->
    <script src="{{ url_for('static', filename='js/vendor/modernizr-2.8.3.min.js') }}"></script>

    <style>
        .custom-popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
    </style>
    <style>
    // ... existing styles ...
    
    .toolhive-logo {
        text-decoration: none;
        display: block;
        padding: 10px 0;
    }

    .logo-text {
        font-size: 32px;
        font-weight: 700;
        color: #333;
        font-family: 'Lily Script One', cursive;
    }

    .logo-text .highlight {
        color: #ff6a00;
    }

    @media (max-width: 768px) {
        .logo-text {
            font-size: 24px;
        }
    }
</style>
</head>

<body>
    <!-- Header Area Start -->
    <header>
        <!-- Header content (navigation, logo, etc.) goes here -->
    </header>
    <!-- Header Area End -->

    <!-- Breadcrumb Start -->
    <div class="breadcrumb-area pt-60 pb-55 pt-sm-30 pb-sm-20">
        <div class="container">
            <div class="breadcrumb">
                <ul>
                    <li><a href="/index">Home</a></li>
                    <li class="active"><a href="/cart">Cart</a></li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Cart Main Area Start -->
    <div class="cart-main-area pb-80 pb-sm-50">
        <div class="container">
           <h2 class="text-capitalize sub-heading">cart</h2>
            <div class="row">
                <div class="col-md-12">
                    <!-- Form Start -->
                    <form id="cart-form" action="#">
                        <!-- Table Content Start -->
                        <div class="table-content table-responsive mb-50">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="product-thumbnail">Image</th>
                                        <th class="product-name">Product</th>
                                        <th class="product-price">Price</th>
                                        
                                        <th class="product-rent-from">Rent From</th>
                                        <th class="product-rent-to">Rent To</th>
                                        <th class="product-quantity">Quantity</th>
                                        <th class="product-subtotal">Total</th>
                                        <th class="product-remove">Remove</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if cart_items %}
                                        {% for item in cart_items %}
                                        <tr data-product-id="{{ item.product_id }}" data-cart-item-id="{{ item.cart_item_id }}">
                                            <td class="product-thumbnail">
                                                <a href="#"><img src="{{ item.product_image }}" alt="cart-image" /></a>
                                            </td>
                                            <td class="product-name"><a href="#">{{ item.product_name }}</a></td>
                                            <td class="product-price"><span class="amount" id="price_{{ item.product_id }}">{{ item.product_price }}</span></td>
                                           
                                            <td class="product-rent-from">
                                                <input type="date" class="rent-from" value="{{ item.rent_from }}" data-cart-item-id="{{ item.cart_item_id }}" min="">
                                            </td>
                                            <td class="product-rent-to">
                                                <input type="date" class="rent-to" value="{{ item.rent_to }}" data-cart-item-id="{{ item.cart_item_id }}" min="">
                                            </td>
                                            <td class="product-quantity">
                                                <div class="quantity-wrapper">
                                                    <button type="button" onclick="decrementQuantity('{{ item.product_id }}')">-</button>
                                                    <input type="number" id="quantity_{{ item.product_id }}" name="quantity" class="quantity" value="{{ item.product_quantity }}" min="1" max="5" onchange="updatePrice('{{ item.product_id }}')" />
                                                    <button type="button" onclick="incrementQuantity('{{ item.product_id }}')">+</button>
                                                </div>
                                            </td>
                                            <td class="product-subtotal"><span id="total_{{ item.product_id }}">{{ item.total_price }}</span></td>
                                            <td class="product-remove">
                                                <button class="remove-from-cart" data-cart-item-id="{{ item.cart_item_id }}">
                                                    <i class="fa fa-times" aria-hidden="true"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="8">Your cart is empty.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Table Content End -->
                    
                        <!-- Cart Buttons Start -->
                        <div class="row">
                            <div class="col-lg-8 col-md-7">
                                <div class="buttons-cart">
                                    <a href="/index">Continue Shopping</a>
                                </div>
                            </div>
                            <!-- Cart Totals Start -->
                            <div class="col-lg-4 col-md-12">
                                <div class="cart_totals">
                                    <h2>Cart Totals</h2>
                                    <br />
                                    <table>
                                        <tbody>
                                            <tr class="order-total">
                                                <th>Total</th>
                                                <td>
                                                    <strong><span class="amount" id="cart_total">0.00</span></strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="wc-proceed-to-checkout">
                                        <a href="{{ url_for('checkout') }}" id="checkoutButton" class="btn">Proceed to Checkout</a>
                                    </div>
                                </div>
                            </div>
                            <!-- Cart Totals End -->
                        </div>
                        <!-- Row End -->
                    </form>
                    <!-- Form End -->
                    </div>
                    </div>
                    <!-- Row End -->
                    </div>
                    </div>
                    <!-- Cart Main Area End -->
                    
                    <!-- Footer Start -->
                    <footer>
                        <!-- Footer content goes here -->
                    </footer>
                    <!-- Footer End -->
                        <!-- Include Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Include your Firebase configuration -->
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyB42nHmPcpj7BmOPPdO93lXqzA3PjjXZOc",
            authDomain: "project-dbebd.firebaseapp.com",
            projectId: "project-dbebd",
            storageBucket: "project-dbebd.appspot.com",
            messagingSenderId: "374516311348",
            appId: "1:374516311348:web:d916facf6720a4e275f161",
            databaseURL: "https://project-dbebd-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get a reference to the database service
        var database = firebase.database();

        // Function to update cart UI (you can implement this later)
        function updateCartUI(cartItems) {
            console.log('Updating cart UI with:', cartItems);
            // Implement your logic here to update the cart UI
        }

        // Listen for changes in the cart
        const userId = "{{ user_id }}"; // Make sure this is populated from your Flask template
        database.ref('/cart/' + userId).on('value', (snapshot) => {
            const cartItems = snapshot.val();
            updateCartUI(cartItems);
        });
    </script>
                    <!-- JavaScript -->
                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                    
                    <script>
                        $(document).ready(function() {
                            // Set minimum date and disable past dates for all date inputs
                            setMinDatesAndDisablePast();

                            function setMinDatesAndDisablePast() {
                                var today = new Date().toISOString().split('T')[0];
                                $('.rent-from, .rent-to').attr('min', today);
                                
                                $('.rent-from, .rent-to').each(function() {
                                    $(this).on('input', function() {
                                        this.setCustomValidity('');
                                        if (this.value < today) {
                                            this.setCustomValidity('Please select a date from today onwards.');
                                        }
                                    });
                                });
                            }

                            function updateRentDates(cartItemId, rentFrom, rentTo) {
                                console.log('Updating rent dates:', cartItemId, rentFrom, rentTo);
                                $.ajax({
                                    url: "{{ url_for('update_rent_dates') }}",
                                    method: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        cart_item_id: cartItemId,
                                        rent_from: rentFrom,
                                        rent_to: rentTo
                                    }),
                                    success: function(response) {
                                        console.log('Success response:', response);
                                        if (response.success) {
                                            showPopup('Rent dates updated successfully');
                                            const $row = $(`tr[data-cart-item-id="${cartItemId}"]`);
                                            const itemKey = $row.data('product-id');
                                            updatePrice(itemKey);  // Update price after successful date change
                                        } else {
                                            showPopup('Failed to update rent dates: ' + response.message);
                                        }
                                    },
                                    error: function(jqXHR, textStatus, errorThrown) {
                                        console.error('Error updating rent dates:', textStatus, errorThrown);
                                        console.error('Response:', jqXHR.responseText);
                                        showPopup('Error updating rent dates. Please try again.');
                                    }
                                });
                            }

                            $('.rent-from').on('change', function() {
                                var $row = $(this).closest('tr');
                                var $rentTo = $row.find('.rent-to');
                                $rentTo.attr('min', $(this).val());
                                
                                validateAndUpdate($row);
                            });

                            $('.rent-to').on('change', function() {
                                var $row = $(this).closest('tr');
                                validateAndUpdate($row);
                            });

                            function validateAndUpdate($row) {
                                var cartItemId = $row.data('cart-item-id');
                                var rentFrom = $row.find('.rent-from').val();
                                var rentTo = $row.find('.rent-to').val();
                                var today = new Date().toISOString().split('T')[0];
                                
                                // Calculate max date (30 days from today)
                                var maxDate = new Date();
                                maxDate.setDate(maxDate.getDate() + 30);
                                var maxDateStr = maxDate.toISOString().split('T')[0];
                                
                                // Set the max attribute for both date inputs
                                $row.find('.rent-from, .rent-to').attr('max', maxDateStr);
                                
                                console.log(`Date changed for item ${cartItemId}: From ${rentFrom} To ${rentTo}`);
                                
                                if (cartItemId && rentFrom && rentTo) {
                                    if (rentFrom < today) {
                                        showPopup('Please select dates from today onwards');
                                        return;
                                    }
                                    if (rentFrom > maxDateStr || rentTo > maxDateStr) {
                                        showPopup('Maximum rental period is 30 days from today');
                                        return;
                                    }
                                    if (new Date(rentFrom) > new Date(rentTo)) {
                                        showPopup('Rent-to date must be after rent-from date');
                                        return;
                                    }
                                    updateRentDates(cartItemId, rentFrom, rentTo);
                                } else {
                                    console.log('Waiting for both dates to be set');
                                }
                            }

                            // Initial calculation of cart total
                            updateCartTotal();
                    
                            // Handle form submission
                            $('#cart-form').on('submit', function(event) {
                                event.preventDefault();
                                console.log('Form submitted');
                                updateCart();
                            });
                        });
                    
                        // Function to get the user's UID
                        function getUserId() {
                            return "{{ user_id }}";  // This will be populated from the Flask template
                        }
                    
                        // Function to calculate rental days
                        function calculateRentalDays(startDate, endDate) {
                            if (!startDate || !endDate) return 1;
                            const start = new Date(startDate);
                            const end = new Date(endDate);
                            const diffTime = Math.abs(end - start);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            return Math.max(diffDays + 1, 1); // Include both start and end days, minimum 1 day
                        }
                    
                        // Update the price for a specific item
                        function updatePrice(itemKey) {
                            const $row = $(`tr[data-product-id="${itemKey}"]`);
                            const quantity = parseInt($row.find('.quantity').val());
                            
                            // Check if quantity exceeds maximum of 5
                            if (quantity > 5) {
                                $row.find('.quantity').val(5);
                                showPopup('Maximum quantity per item is 5');
                                return updatePrice(itemKey); // Recursively call with corrected value
                            }
                            
                            const pricePerUnit = parseFloat($row.find('.product-price .amount').text().replace('₹', ''));
                            const rentFrom = $row.find('.rent-from').val();
                            const rentTo = $row.find('.rent-to').val();
                            const rentalDays = calculateRentalDays(rentFrom, rentTo);
                            const totalPrice = quantity * pricePerUnit * rentalDays;

                            console.log(`Updating price for item ${itemKey}:`);
                            console.log(`- Quantity: ${quantity}`);
                            console.log(`- Price per unit: ${pricePerUnit}`);
                            console.log(`- Rent from: ${rentFrom}`);
                            console.log(`- Rent to: ${rentTo}`);
                            console.log(`- Rental days: ${rentalDays}`);
                            console.log(`- Calculated total price: ${totalPrice}`);

                            $row.attr('data-total-price', totalPrice.toFixed(2));
                            $row.find('.product-subtotal span').text('₹' + totalPrice.toFixed(2));
                            updateCartTotal();
                            updateQuantityInBackend(itemKey, quantity);
                        }
                    
                        // Update the total price of the cart
                        function updateCartTotal() {
                            let total = 0;
                            console.log('Updating cart total:');
                            $('tr[data-product-id]').each(function() {
                                const itemTotal = parseFloat($(this).attr('data-total-price') || 0);
                                const itemId = $(this).data('product-id');
                                console.log(`- Item ${itemId}: ${itemTotal}`);
                                total += itemTotal;
                            });
                            console.log(`Final cart total: ${total}`);
                            $('#cart_total').text('₹' + total.toFixed(2));
                        }
                    
                        // Increment the quantity of a specific item
                        function incrementQuantity(itemKey) {
                            const quantityInput = document.getElementById('quantity_' + itemKey);
                            const $row = $(`tr[data-product-id="${itemKey}"]`);
                            const rentFrom = $row.find('.rent-from').val();
                            const rentTo = $row.find('.rent-to').val();
                            
                            if (!rentFrom || !rentTo) {
                                showPopup('Please select rental dates before adjusting quantity');
                                return;
                            }
                            
                            if (quantityInput) {
                                let quantity = parseInt(quantityInput.value) + 1;
                                if (quantity > 5) {
                                    showPopup('Maximum quantity per item is 5');
                                    return;
                                }
                                quantityInput.value = quantity;
                                updatePrice(itemKey);
                            }
                        }
                    
                        // Decrement the quantity of a specific item
                        function decrementQuantity(itemKey) {
                            const quantityInput = document.getElementById('quantity_' + itemKey);
                            const $row = $(`tr[data-product-id="${itemKey}"]`);
                            const rentFrom = $row.find('.rent-from').val();
                            const rentTo = $row.find('.rent-to').val();
                            
                            if (!rentFrom || !rentTo) {
                                showPopup('Please select rental dates before adjusting quantity');
                                return;
                            }
                            
                            if (quantityInput) {
                                let quantity = parseInt(quantityInput.value);
                                if (quantity > 1) {
                                    quantity -= 1;
                                    quantityInput.value = quantity;
                                    updatePrice(itemKey);
                                } else {
                                    showPopup('Quantity cannot be less than 1.');
                                }
                            }
                        }
                    
                        // Event listeners for quantity changes
                        $('.quantity').on('change', function() {
                            const itemKey = $(this).closest('tr').data('product-id');
                            updatePrice(itemKey);
                        });
                    
                        // Event listeners for date changes
                        $('.rent-from, .rent-to').on('change', function() {
                            const $row = $(this).closest('tr');
                            const cartItemId = $row.data('cart-item-id');
                            const rentFrom = $row.find('.rent-from').val();
                            const rentTo = $row.find('.rent-to').val();
                            console.log(`Date changed for item ${cartItemId}: From ${rentFrom} To ${rentTo}`);
                            validateAndUpdate($row);
                        });
                    
                        // Send updated quantity information to the backend
                        function updateQuantityInBackend(itemKey, quantity) {
                            const userId = getUserId();
                            if (!userId) {
                                showPopup('User ID is missing. Please log in again.');
                                return;
                            }

                            $.ajax({
                                url: '/update-cart',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    user_id: userId,
                                    cart: [{ product_id: itemKey, quantity: quantity }]
                                }),
                                success: function(response) {
                                    console.log('Quantity updated successfully', response);
                                    if (response.success) {
                                        $('#cart_total').text('₹' + response.total.toFixed(2));
                                        updateCartTotal();  // Update the cart total display
                                        
                                        // Update each item in the cart
                                        response.updated_items.forEach(function(item) {
                                            const itemRow = $(`tr[data-product-id="${item.product_id}"]`);
                                            const quantityInput = itemRow.find('.quantity');
                                            quantityInput.val(item.quantity);
                                            quantityInput.attr('max', item.max_quantity);
                                            itemRow.find('.product-subtotal span').text('₹' + item.total_price.toFixed(2));
                                            
                                            if (item.quantity !== quantity) {
                                                showPopup(`Quantity for ${item.product_name} adjusted to ${item.quantity} due to stock limitations.`);
                                            }
                                        });
                                    }
                                },
                                error: function(jqXHR, textStatus, errorThrown) {
                                    console.error('Error updating quantity:', textStatus, errorThrown, jqXHR.responseText);
                                    showPopup('Error updating quantity. Please try again.');
                                }
                            });
                        }
                    
                        // Remove an item from the cart
                        function removeFromCart(cartItemId) {
                            console.log('Attempting to remove item:', cartItemId);
                            $.ajax({
                                url: '/remove-from-cart/' + cartItemId,
                                method: 'POST',
                                success: function(response) {
                                    console.log('Server response:', response);
                                    if (response.success) {
                                        console.log('Item removed successfully from server');
                                        $('tr[data-cart-item-id="' + cartItemId + '"]').remove();
                                        updateCartTotal();
                                        updateCheckoutButton();
                                        showPopup(response.message);
                                    } else {
                                        console.error('Failed to remove item:', response.message);
                                        showPopup('Failed to remove item: ' + response.message);
                                    }
                                },
                                error: function(jqXHR, textStatus, errorThrown) {
                                    console.error('Error removing item:', textStatus, errorThrown);
                                    console.error('Response text:', jqXHR.responseText);
                                    let errorMessage = 'Error removing item. ';
                                    try {
                                        let errorResponse = JSON.parse(jqXHR.responseText);
                                        errorMessage += errorResponse.message || '';
                                    } catch (e) {
                                        errorMessage += 'Please try again.';
                                    }
                                    showPopup(errorMessage);
                                }
                            });
                        }
                    
                        // Update the cart with new data
                        function updateCart() {
                            const userId = getUserId();  // Get the user's UID
                            if (!userId) {
                                showPopup('User ID is missing. Please log in again.');
                                return;  // Exit the function or handle the error appropriately
                            }
                    
                            var cartData = [];
                            $('table tbody tr').each(function() {
                                var $row = $(this);
                                var productId = $row.data('product-id');
                                var quantity = $row.find('.quantity').val();
                                cartData.push({ product_id: productId, quantity: quantity });
                            });
                    
                            $.ajax({
                                url: '/update-cart',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ user_id: userId, cart: cartData }),
                                success: function(response) {
                                    if (response.success) {
                                        console.log('Cart updated successfully');
                                        updateCartTotal();
                                    }
                                },
                                error: function(jqXHR, textStatus, errorThrown) {
                                    console.error('Error updating cart:', textStatus, errorThrown, jqXHR.responseText);
                                }
                            });
                        }

                        function showPopup(message) {
                            const popup = document.getElementById('custom-popup');
                            const popupMessage = document.getElementById('popup-message');
                            popupMessage.textContent = message;
                            popup.style.display = 'block';
                            setTimeout(() => {
                                popup.style.display = 'none';
                            }, 3000);
                        }

                        function proceedToCheckout(event) {
                            event.preventDefault();
                            
                            var dateInputs = document.querySelectorAll('.rent-from, .rent-to');
                            var allDatesSelected = true;
                            
                            dateInputs.forEach(function(input) {
                                if (!input.value) {
                                    allDatesSelected = false;
                                    input.style.border = '2px solid red';
                                } else {
                                    input.style.border = '';
                                }
                            });
                            
                            if (allDatesSelected) {
                                window.location.href = "{{ url_for('checkout') }}";
                            } else {
                                showPopup('Please select both "Rent From" and "Rent To" dates for all items before proceeding to checkout.');
                            }
                        }
                    
                        // Attach the proceedToCheckout function to the checkout button
                        document.addEventListener('DOMContentLoaded', function() {
                            const checkoutButton = document.getElementById('checkoutButton');
                            checkoutButton.addEventListener('click', proceedToCheckout);
                        });
                    </script>
                    
    <!-- Additional Scripts -->
    <script src="{{ url_for('static', filename='js/vendor/jquery-1.12.4.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.meanmenu.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.scrollUp.js') }}"></script>
    <script src="{{ url_for('static', filename='js/owl.carousel.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/slick.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/wow.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.countdown.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.nivo.slider.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.fancybox.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/plugins.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <div id="custom-popup" class="custom-popup" style="display: none;">
        <p id="popup-message"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkoutButton = document.getElementById('checkoutButton');
        const cartItems = {{ cart_items|tojson }};

        // Add function to count total unique products in cart
        function getTotalUniqueProducts() {
            return document.querySelectorAll('tr[data-cart-item-id]').length;
        }

        // Check if cart has reached maximum product limit
        function isCartFull() {
            return getTotalUniqueProducts() >= 5;
        }

        function updateCheckoutButton() {
            const cartItems = document.querySelectorAll('tr[data-cart-item-id]');
            if (cartItems.length === 0) {
                checkoutButton.classList.add('disabled');
                checkoutButton.setAttribute('aria-disabled', 'true');
                checkoutButton.onclick = function(event) {
                    event.preventDefault();
                };
            } else {
                checkoutButton.classList.remove('disabled');
                checkoutButton.removeAttribute('aria-disabled');
                checkoutButton.onclick = null;
            }
            
            // Add cart full indicator if at max limit
            if (isCartFull()) {
                if (!document.getElementById('cart-full-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.id = 'cart-full-indicator';
                    indicator.className = 'cart-limit-warning';
                    indicator.textContent = 'Cart limit: 5 products maximum';
                    document.querySelector('.cart_totals').prepend(indicator);
                }
            } else {
                const indicator = document.getElementById('cart-full-indicator');
                if (indicator) indicator.remove();
            }
        }

        // Initial check
        updateCheckoutButton();

        // Function to remove item from cart
        function removeFromCart(cartItemId) {
            console.log('Attempting to remove item:', cartItemId);
            $.ajax({
                url: '/remove-from-cart/' + cartItemId,
                method: 'POST',
                success: function(response) {
                    console.log('Server response:', response);
                    if (response.success) {
                        console.log('Item removed successfully from server');
                        $('tr[data-cart-item-id="' + cartItemId + '"]').remove();
                        updateCartTotal();
                        updateCheckoutButton();
                        showPopup(response.message);
                    } else {
                        console.error('Failed to remove item:', response.message);
                        showPopup('Failed to remove item: ' + response.message);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error removing item:', textStatus, errorThrown);
                    console.error('Response text:', jqXHR.responseText);
                    let errorMessage = 'Error removing item. ';
                    try {
                        let errorResponse = JSON.parse(jqXHR.responseText);
                        errorMessage += errorResponse.message || '';
                    } catch (e) {
                        errorMessage += 'Please try again.';
                    }
                    showPopup(errorMessage);
                }
            });
        }

        // Attach event listeners to remove buttons
        document.querySelectorAll('.remove-from-cart').forEach(button => {
            button.addEventListener('click', function() {
                const cartItemId = this.getAttribute('data-cart-item-id');
                removeFromCart(cartItemId);
            });
        });
    });
    </script>

    <!-- Date Validation Functions -->
    <script>
    function validateDates() {
        const today = new Date().toISOString().split('T')[0];
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 30);
        const maxDateStr = maxDate.toISOString().split('T')[0];

        // Set min/max dates for all date inputs
        $('.rent-from, .rent-to').each(function() {
            $(this).attr({
                'min': today,
                'max': maxDateStr
            });

            // Add change event listener
            $(this).on('change', function() {
                const $row = $(this).closest('tr');
                const rentFrom = $row.find('.rent-from').val();
                const rentTo = $row.find('.rent-to').val();

                if (rentFrom && rentTo) {
                    // Validate date range
                    if (rentFrom > rentTo) {
                        showPopup('End date must be after start date');
                        $(this).val('');
                        return false;
                    }
                    
                    // Validate rental period
                    const daysDiff = (new Date(rentTo) - new Date(rentFrom)) / (1000 * 60 * 60 * 24);
                    if (daysDiff > 30) {
                        showPopup('Maximum rental period is 30 days');
                        $(this).val('');
                        return false;
                    }
                }
            });
        });
    }

    // Add this to your document ready function
    $(document).ready(function() {
        validateDates();
    });
    </script>

    <script>
    $(document).ready(function() {
        // Initially disable all quantity controls
        disableQuantityControls();

        // Event listener for date inputs
        $('.rent-from, .rent-to').on('change', function() {
            const $row = $(this).closest('tr');
            const rentFrom = $row.find('.rent-from').val();
            const rentTo = $row.find('.rent-to').val();

            // Enable/disable quantity controls based on date selection
            if (rentFrom && rentTo) {
                enableQuantityControls($row);
            } else {
                disableQuantityControls($row);
            }
        });
    });

    function disableQuantityControls(row = null) {
        const $elements = row ? row.find('.quantity, .qty-btn') : $('.quantity, .qty-btn');
        $elements.prop('disabled', true).addClass('disabled');
        
        // Add visual feedback
        $elements.closest('.quantity-wrapper').addClass('dates-required');
        if (!row) {
            // Add message when initially loading
            $('.quantity-wrapper').append('<small class="text-muted">Select dates first</small>');
        }
    }

    function enableQuantityControls($row) {
        const $controls = $row.find('.quantity, .qty-btn');
        $controls.prop('disabled', false).removeClass('disabled');
        $controls.closest('.quantity-wrapper').removeClass('dates-required');
        $row.find('.quantity-wrapper small').remove();
    }
    </script>

    <style>
    .quantity-wrapper.dates-required {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .quantity-wrapper small {
        display: block;
        color: #6c757d;
        font-size: 12px;
        margin-top: 4px;
    }

    .qty-btn.disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .quantity:disabled {
        background-color: #e9ecef;
    }
    </style>

    <!-- Add styles for cart limit warning -->
    <style>
    .cart-limit-warning {
        background-color: #fff3cd;
        color: #856404;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 14px;
        border-left: 4px solid #ffc107;
    }
    </style>

    <!-- Initial check for cart limit on page load -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check cart limit on page load
        if (getTotalUniqueProducts() >= 5) {
            showPopup("Maximum 5 products allowed in cart");
            const indicator = document.createElement('div');
            indicator.id = 'cart-full-indicator';
            indicator.className = 'cart-limit-warning';
            indicator.textContent = 'Cart limit: 5 products maximum';
            document.querySelector('.cart_totals').prepend(indicator);
        }
    });
    </script>
</body>
</html>