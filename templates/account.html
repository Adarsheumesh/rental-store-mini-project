<!doctype html>
<html class="no-js" lang="en-US">


<!-- Mirrored from htmldemo.net/jantrik/jantrik/account.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 05 Jul 2024 04:21:11 GMT -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Account || Jantrik Bootstrap5 Template for Tools, Equipment Store</title>
    <meta name="description" content="Default Description">
    <meta name="keywords" content="E-commerce" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- place favicon.ico in the root directory -->
   <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='img/icon/favicon.png') }}">

   <!-- Google Font css -->
   <link href="http://fonts.googleapis.com/css?family=Lily+Script+One" rel="stylesheet"> 

 <!-- mobile menu css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/meanmenu.min.css') }}">
 <!-- animate css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}">
 <!-- nivo slider css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/nivo-slider.css') }}">
 <!-- owl carousel css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.carousel.min.css') }}">
 <!-- slick css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/slick.css') }}">
 <!-- price slider css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui.min.css') }}">
 <!-- fontawesome css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
 <!-- fancybox css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.fancybox.css') }}">
 <!-- bootstrap css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
 <!-- default css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/default.css') }}">
 <!-- style css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
 <!-- responsive css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">

 <!-- modernizr js -->
 <script src="{{ url_for('static', filename='js/vendor/modernizr-2.8.3.min.js') }}"></script>
 
    <style>
        .user-account-dropdown {
            position: relative;
        }

        .user-account-dropdown .user-toggle {
            color: #2874f0;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            padding: 8px 12px;
            background-color: #fff;
            border-radius: 2px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .user-account-dropdown .user-toggle:hover {
            background-color: #f0f0f0;
        }

        .user-account-dropdown .user-toggle i {
            margin-right: 5px;
        }

        .user-account-dropdown .ht-dropdown.user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            display: none;
            z-index: 1000;
            min-width: 200px;
            padding: 5px 0;
        }

        .user-account-dropdown:hover .ht-dropdown.user-menu {
            display: block;
        }

        .user-account-dropdown .ht-dropdown.user-menu li {
            list-style: none;
        }

        .user-account-dropdown .ht-dropdown.user-menu a {
            display: block;
            padding: 10px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .user-account-dropdown .ht-dropdown.user-menu a:hover {
            background-color: #f5f5f5;
            color: #2874f0;
        }

        .user-account-dropdown .ht-dropdown.user-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .user-account-dropdown .ht-dropdown.user-menu .divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 5px 0;
        }

        #refundNotification {
            min-width: 300px;
            max-width: 400px;
            border: 1px solid #ddd;
            animation: fadeInOut 3.3s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        .order-progress {
            margin: 2rem 0;
            position: relative;
        }

        .progress-track {
            margin: 30px 0;
            position: relative;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            width: 20%;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step.active .step-icon {
            border-color: #007bff;
            background: #007bff;
            color: #fff;
        }

        .step.completed .step-icon {
            border-color: #28a745;
            background: #28a745;
            color: #fff;
        }

        .step-text {
            font-size: 12px;
            margin: 5px 0;
        }

        .step-date {
            font-size: 11px;
            color: #666;
        }

        .progress-fill {
            height: 3px;
            background: #4e73df;
            width: 0;
            transition: width 0.5s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .progress-label {
            text-align: center;
            position: relative;
            width: 16.66%; /* Updated for 6 steps */
        }

        .progress-label.active {
            color: #4e73df;
            font-weight: 600;
        }

        .progress-label.completed {
            color: #1cc88a;
            font-weight: 600;
        }
    </style>
    <style>
        // ... existing styles ...
        
        .toolhive-logo {
            text-decoration: none;
            display: block;
            padding: 10px 0;
        }
    
        .logo-text {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            font-family: 'Lily Script One', cursive;
        }
    
        .logo-text .highlight {
            color: #ff6a00;
        }
    
        @media (max-width: 768px) {
            .logo-text {
                font-size: 24px;
            }
        }
    </style>

    <!-- Update the modal HTML -->
    <style>
        /* Remove modal backdrop */
        .modal-backdrop {
            display: none !important;
        }
        
        /* Ensure modal is visible without backdrop */
        .modal {
            background: transparent !important;
        }
        
        /* Optional: Add a subtle box shadow to make modal stand out */
        .modal-content {
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
    <!--[if lt IE 8]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <!-- Wrapper Start -->
    <div class="wrapper">
        <!-- Header Area Start -->
        <header>
            <!-- Header Top Start -->
            
            <!-- Header Top End -->
            <!-- Header Bottom Start -->
            <div class="header-bottom header-sticky">
                <div class="container">
                    <div class="row justify-content-between">
                        <!--  logo Start-->
                        <div class="col-auto">
                            <div class="logo">
                                <a href="/index" class="toolhive-logo">
                                    <span class="logo-text">Tool<span class="highlight">Hive</span></span>
                                </a>
                            </div>                          
                        </div>
                       <!--  logo End -->

                        <!--  Desktop Memu Start -->
                        
                        <!--  Desktop Memu End -->
                        
                        <!--  Cartt Box  Start -->
                        <div class="col-auto">
                            <div class="cart-box text-end">
                                <ul>
                                    <li class="user-account-dropdown">
                                        <a href="#" class="user-toggle">
                                            <i class="fa fa-user-circle"></i> Hello, {{ user_info.name }} <i class="fa fa-angle-down"></i>
                                        </a>
                                        <ul class="ht-dropdown user-menu">
                                            <li><a href="/account"><i class="fa fa-user"></i> My Account</a></li>
                                            <li><a href="/wishlist"><i class="fa fa-heart"></i> Wishlist</a></li>
                                            <li class="divider"></li>
                                            <li><a href="/logout"><i class="fa fa-sign-out"></i> Logout</a></li>
                                        </ul>
                                    </li>                                    
                                    <li><a href="/wishlist"><i class="fa fa-heart-o"></i></a></li>
                                    <li>
                                        <a href="/cart"><i class="fa fa-shopping-basket"></i><span class="cart-counter">{{ cart_count }}</span></a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!--  Cartt Box  End-->
                       
                        <!-- Mobile Menu  End -->                        
                    </div>
                    <!-- Row End -->
                </div>
                <!-- Container End -->
            </div>
            <!-- Header Bottom End -->
        </header>
        <!-- Header Area End -->
        <!-- Breadcrumb Start -->
        <div class="breadcrumb-area ptb-60 ptb-sm-30">
            <div class="container">
                <div class="breadcrumb">
                    <ul>
                        <li><a href="/index">Home</a></li>
                        <li class="active"><a href="/account">Account</a></li>
                    </ul>
                </div>
            </div>
            <!-- Container End -->
        </div>
        <!-- Breadcrumb End -->
        <!-- My Account Page Start Here -->
        <div class="my-account white-bg pb-60">
            <div class="container">
                <div class="account-dashboard">
                   
                   <div class="row">
                    <div class="col-lg-2">
                        <!-- Nav tabs -->
                        <ul class="nav flex-column dashboard-list" role="tablist">
                            <li><a class="active" data-bs-toggle="tab" href="#account-details">Account details</a></li>
                            <li><a data-bs-toggle="tab" href="#orders">Orders</a></li>
                            
                            
                            <li><a data-bs-toggle="tab" href='#edit-account-details'>Edit Account details</a></li>
                            <li><a href="/logout">logout</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-10">
                        <!-- Tab panes -->
                        <div class="tab-content dashboard-content mt-all-40">
                            <div id="account-details" class="tab-pane active">
                                <h3>Account details </h3>
                                <div class="register-form login-form clearfix">
                                    <form action="#">
                                        <div class="form-group row">
                                            <label for="f-name" class="col-lg-3 col-md-4 col-form-label">Name</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label>{{ user_info.name }}</label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="l-name" class="col-lg-3 col-md-4 col-form-label">District</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label>{{ user_info.district }} </label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="address" class="col-lg-3 col-md-4 col-form-label">Address</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label style="white-space: pre-line;">{{ user_info.address }}</label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="email" class="col-lg-3 col-md-4 col-form-label">Email address</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label>{{ user_info.email }} </label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="inputpassword" class="col-lg-3 col-md-4 col-form-label">Phone No</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label>{{ user_info.phone }} </label>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div id="orders" class="tab-pane fade">
                                <h3>Orders</h3>
                                <div class="order-history-container">
                                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                        <table class="table">
                                            <tbody>
                                                {% for order in orders %}
                                                    <tr>
                                                        <td colspan="5">
                                                            <strong>Order ID: {{ order.get('order_id', 'N/A') }}</strong><br>
                                                            Total Price: ₹{{ "%.2f"|format(order.get('order_total', 0)) }}<br>
                                                            Order Date: {{ order.get('created_at', 'N/A') }}
                                                        </td>
                                                    </tr>
                                                    {% for item in order.get('items', []) %}
                                                    <tr id="item-row-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}">
                                                        <td>
                                                            <img src="{{ item.get('image_url', url_for('static', filename='img/default-product.jpg')) }}" 
                                                                 alt="{{ item.get('product_name', 'Product') }}" width="50" height="50">
                                                        </td>
                                                        <td>
                                                            <strong>{{ item.get('product_name', 'Unknown Product') }}</strong><br>
                                                            {% if item.get('color') %}Color: {{ item.get('color') }}{% endif %}
                                                            {% if item.get('size') %}Size: {{ item.get('size') }}{% endif %}
                                                            <br>
                                                            Quantity: <span id="item-quantity-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}">{{ item.get('quantity', 1) }}</span>
                                                        </td>
                                                        <td>₹{{ "%.2f"|format(item.get('total_price', 0)) }}</td>
                                                        <td id="status-cell-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}">
                                                            {% if order.get('items')|length > 1 %}
                                                                {% if item.get('status') == 'cancelled' %}
                                                                    <span class="badge bg-danger">Cancelled</span><br>
                                                                    <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                        
                                                                {% elif item.get('status') == 'partially_cancelled' %}
                                                                    <span class="badge bg-warning text-dark">Partially Cancelled</span><br>
                                                                    <small>Cancelled: {{ item.get('cancelled_quantity', 'N/A') }}, Remaining: {{ item.get('quantity', 'N/A') }}</small>
                                                        
                                                                {% elif item.get('status') == 'returned' %}
                                                                    <span class="badge bg-success">Returned</span><br>
                                                                    <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                        
                                                                {% elif item.get('status') == 'return_initiated' %}
                                                                    <span class="badge bg-warning text-dark">Return Initiated</span><br>
                                                                    <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                        
                                                                {% else %}
                                                                    <span class="badge bg-primary">Active</span><br>
                                                                    <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                                {% endif %}
                                                                <br>
                                                                <small>Quantity: {{ item.get('quantity', 'N/A') }} | Days: {{ item.get('rental_days', 'N/A') }}</small>
                                                        
                                                            {% else %}
                                                                {% if item.get('status') == 'cancelled' %}
                                                                    <span class="badge bg-danger">Cancelled</span><br>
                                                                    <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                        
                                                                {% elif item.get('status') == 'returned' %}
                                                                    <span class="badge bg-success">Returned</span><br>
                                                                    <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                        
                                                                {% elif item.get('status') == 'return_initiated' %}
                                                                    <span class="badge bg-warning text-dark">Return Initiated</span><br>
                                                                    <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                        
                                                                {% else %}
                                                                    <span class="badge bg-primary">Active</span><br>
                                                                    <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                                {% endif %}
                                                                <br>
                                                                <small>Quantity: {{ item.get('quantity', 'N/A') }} | Days: {{ item.get('rental_days', 'N/A') }}</small>
                                                            {% endif %}
                                                        </td>
                                                        <td class="product-add-to-cart">
                                                            <div class="d-flex flex-column gap-2">
                                                                {% if item.get('status') == 'ordered' %}
                                                                    <!-- Cancel Button (show for first 10 minutes when status is ordered) -->
                                                                    <button class="btn btn-outline-danger btn-sm cancel-item" 
                                                                            id="cancel-button-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}"
                                                                            data-order-id="{{ order.get('order_id', '') }}"
                                                                            data-product-id="{{ item.get('product_id', '') }}"
                                                                            data-product-name="{{ item.get('product_name', '') }}"
                                                                            data-order-time="{{ order.get('created_at', '') }}"
                                                                            data-quantity="{{ item.get('quantity', 1) }}">
                                                                        <i class="fa fa-times"></i> Cancel
                                                                    </button>
                                                                {% elif item.get('status') == 'delivered' %}
                                                                    <!-- Return Button (show when status is delivered) -->
                                                                    <button type="button" 
                                                                            class="btn btn-warning btn-sm return-item"
                                                                            data-order-id="{{ order.get('order_id', '') }}"
                                                                            data-product-name="{{ item.get('product_name', '') }}"
                                                                            data-rent-from="{{ item.get('rent_from', '') }}"
                                                                            data-rent-to="{{ item.get('rent_to', '') }}">
                                                                        Return
                                                                    </button>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                    <tr>
                                                        <td colspan="5">
                                                            <strong>Total: </strong><span id="order-total-{{ order.get('order_id', '') }}">₹{{ "%.2f"|format(order.get('order_total', 0)) }}</span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="6">
                                                            <div class="d-flex flex-column align-items-start">
                                                                <div class="btn-group-vertical w-100 mb-2" role="group">
                                                                    <button class="btn btn-outline-primary btn-sm view-order-details" data-order-id="{{ order.get('order_id', '') }}">
                                                                        <i class="fa fa-eye"></i> View Details
                                                                    </button>
                                                                   
                                                                    {% for item in order.get('items', []) %}
                                                                        {% if item.get('status') == 'returned' and item.get('return_completed_at') %}
                                                                            <a href="{{ url_for('download_order_pdf', order_id=order.get('order_id', '')) }}" 
                                                                               class="btn btn-outline-secondary btn-sm download-invoice" 
                                                                               id="download-invoice-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}"
                                                                               data-order-id="{{ order.get('order_id', '') }}" 
                                                                               target="_blank">
                                                                                <i class="fa fa-download"></i> Download Invoice
                                                                            </a>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                </div>
                                                                
                                                                {% if order.get('status') != 'cancelled' %}
                                                                    <div class="btn-group w-100" role="group">
                                                                        {% set all_items_returned = true %}
                                                                        {% for item in order.get('items', []) %}
                                                                            {% if item.get('status') != 'returned' %}
                                                                                {% set all_items_returned = false %}
                                                                            {% endif %}
                                                                        {% endfor %}

                                                                        {% if all_items_returned %}
                                                                            <!-- Download Invoice Button (when all items are returned) -->
                                                                           
                                                                        {% else %}
                                                                            {% for item in order.get('items', []) %}
                                                                                {% if item.get('status') != 'returned' %}
                                                                                    <!-- Return Button (for non-returned items) -->
                                                                                    <button type="button" 
                                                                                            class="btn btn-warning return-item" 
                                                                                            data-order-id="{{ order.get('order_id') }}"
                                                                                            data-product-name="{{ item.get('product_name') }}"
                                                                                            data-rent-from="{{ item.get('rent_from') }}"
                                                                                            data-rent-to="{{ item.get('rent_to') }}">
                                                                                        Return
                                                                                    </button>
                                                                                {% endif %}
                                                                            {% endfor %}
                                                                        {% endif %}

                                                                        
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="5"><hr></td>
                                                    </tr>
                                                {% else %}
                                                <tr>
                                                    <td colspan="5">No orders found.</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                          
                            <div id="edit-account-details" class="tab-pane fade">
                                <h3>Edit Account details </h3>
                                <div class="register-form login-form clearfix">
                                    <form action="{{ url_for('update_account') }}" method="POST" onsubmit="return validateForm()">
                                        <div class="form-group row">
                                            <label for="f-name" class="col-lg-3 col-md-4 col-form-label">Name</label>
                                            <div class="col-lg-6 col-md-8">
                                                <input type="text" class="form-control" id="f-name" name="name" value="{{ user_info.name }}" required oninput="validateName()">
                                                <div id="nameError" style="color: red;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="l-name" class="col-lg-3 col-md-4 col-form-label">District</label>
                                            <div class="col-lg-6 col-md-8">
                                                <select class="form-control" id="l-name" name="district" required onchange="validateDistrict()">
                                                    <option value="">Select your district</option>
                                                    <option value="Alappuzha" {% if user_info.district == 'Alappuzha' %}selected{% endif %}>Alappuzha</option>
                                                    <option value="Ernakulam" {% if user_info.district == 'Ernakulam' %}selected{% endif %}>Ernakulam</option>
                                                    <option value="Idukki" {% if user_info.district == 'Idukki' %}selected{% endif %}>Idukki</option>
                                                    <option value="Kannur" {% if user_info.district == 'Kannur' %}selected{% endif %}>Kannur</option>
                                                    <option value="Kasaragod" {% if user_info.district == 'Kasaragod' %}selected{% endif %}>Kasaragod</option>
                                                    <option value="Kollam" {% if user_info.district == 'Kollam' %}selected{% endif %}>Kollam</option>
                                                    <option value="Kottayam" {% if user_info.district == 'Kottayam' %}selected{% endif %}>Kottayam</option>
                                                    <option value="Kozhikode" {% if user_info.district == 'Kozhikode' %}selected{% endif %}>Kozhikode</option>
                                                    <option value="Malappuram" {% if user_info.district == 'Malappuram' %}selected{% endif %}>Malappuram</option>
                                                    <option value="Palakkad" {% if user_info.district == 'Palakkad' %}selected{% endif %}>Palakkad</option>
                                                    <option value="Pathanamthitta" {% if user_info.district == 'Pathanamthitta' %}selected{% endif %}>Pathanamthitta</option>
                                                    <option value="Thiruvananthapuram" {% if user_info.district == 'Thiruvananthapuram' %}selected{% endif %}>Thiruvananthapuram</option>
                                                    <option value="Thrissur" {% if user_info.district == 'Thrissur' %}selected{% endif %}>Thrissur</option>
                                                    <option value="Wayanad" {% if user_info.district == 'Wayanad' %}selected{% endif %}>Wayanad</option>
                                                </select>
                                                <div id="districtError" style="color: red;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="address" class="col-lg-3 col-md-4 col-form-label">Address</label>
                                            <div class="col-lg-6 col-md-8">
                                                <textarea class="form-control" id="address" name="address" rows="3" required oninput="validateAddress()">{{ user_info.address }}</textarea>
                                                <div id="addressError" style="color: red;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="phone" class="col-lg-3 col-md-4 col-form-label">Phone No</label>
                                            <div class="col-lg-6 col-md-8">
                                                <input type="tel" class="form-control" id="phone" name="phone" value="{{ user_info.phone }}" required oninput="validatePhone()">
                                                <div id="phoneError" style="color: red;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <div class="col-lg-6 col-md-8">
                                                <button type="submit" class="btn btn-primary">Update</button>
                                            </div>
                                        </div>
                                    </form>
                
                                    {% with messages = get_flashed_messages(with_categories=true) %}
                                    {% if messages %}
                                        {% for category, message in messages %}
                                            <div class="alert alert-{{ category }}">
                                                {{ message }}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                    {% endwith %}

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script>
    function validateName() {
        const nameInput = document.getElementById('f-name');
        // Replace any character that is not a letter or space with an empty string
        nameInput.value = nameInput.value.replace(/[^A-Za-z\s]/g, '');

        // Display error if any invalid character is entered
        const regex = /^[A-Za-z\s]+$/;
        if (!regex.test(nameInput.value)) {
            document.getElementById('nameError').innerText = 'Name can only contain letters and spaces.';
            return false;
        } else {
            document.getElementById('nameError').innerText = '';
            return true;
        }
    }

    function validateDistrict() {
        const districtInput = document.getElementById('l-name');
        // Replace any character that is not a letter or space with an empty string
        districtInput.value = districtInput.value.replace(/[^A-Za-z\s]/g, '');

        // Display error if any invalid character is entered
        const regex = /^[A-Za-z\s]+$/;
        if (!regex.test(districtInput.value) || districtInput.value.trim() === '') {
            document.getElementById('districtError').innerText = 'Address can only contain letters and spaces.';
            return false;
        } else {
            document.getElementById('districtError').innerText = '';
            return true;
        }
    }

    function validatePhone() {
        const phoneInput = document.getElementById('phone');
        // Replace any character that is not a digit with an empty string
        phoneInput.value = phoneInput.value.replace(/[^0-9]/g, '');

        // Display error if any invalid character is entered
        const regex = /^[0-9]{10}$/;
        if (!regex.test(phoneInput.value)) {
            document.getElementById('phoneError').innerText = 'Phone number must be 10 digits.';
            return false;
        } else {
            document.getElementById('phoneError').innerText = '';
            return true;
        }
    }

    function validateAddress() {
        const address = document.getElementById('address');
        const addressError = document.getElementById('addressError');
        const addressValue = address.value.trim();
        
        // Regular expression to allow only letters, numbers, spaces, commas, periods, and newlines
        const validAddressPattern = /^[a-zA-Z0-9\s,.'"\n]+$/;
        
        if (!addressValue) {
            addressError.textContent = 'Please enter your address';
            return false;
        } else if (addressValue.length < 10) {
            addressError.textContent = 'Address should be at least 10 characters long';
            return false;
        } else if (!validAddressPattern.test(addressValue)) {
            addressError.textContent = 'Address can only contain letters, numbers, spaces, commas, and periods';
            address.value = addressValue.replace(/[^a-zA-Z0-9\s,.'"\n]/g, '');
            return false;
        } else {
            addressError.textContent = '';
            return true;
        }
    }

    function validateForm() {
        const isNameValid = validateName();
        const isDistrictValid = validateDistrict();
        const isPhoneValid = validatePhone();
        const isAddressValid = validateAddress();
        
        return isNameValid && isDistrictValid && isPhoneValid && isAddressValid;
    }
</script>
                    
                </div>
            </div>
        </div>
        <!-- My Account Page End Here -->
        <!-- Brand Logo Start -->
        <div class="brand-area pb-60">
            <div class="container">
                <!-- Brand Banner Start -->
                <div class="brand-banner owl-carousel">
                    <div class="single-brand">
                        <a href="#"><img class="img" src="{{ url_for('static', filename='img/brand/1.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/2.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/3.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/4.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/5.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img class="img" src="{{ url_for('static', filename='img/brand/1.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/2.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/3.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/4.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/5.png') }}" alt="brand-image"></a>
                    </div>
                </div>
                <!-- Brand Banner End -->                
            </div>
            
        </div>
        <!-- Brand Logo End -->

        <footer class="off-white-bg">
            <!-- Footer Top Start -->
            <div class="footer-top pt-50 pb-60">
                <div class="container">
                                  
                    <div class="row">
                        <!-- Single Footer Start -->
                        <div class="col-lg-4  col-md-7 col-sm-6">
                            <div class="single-footer">
                                <h3>Contact us</h3>
                                <div class="footer-content">
                                    <div class="loc-address">
                                        <span><i class="fa fa-map-marker"></i>Toolhive Building Y Road.</span>
                                        <span><i class="fa fa-envelope-o"></i>toolhive@gmail.com</span>
                                        <span><i class="fa fa-phone"></i>Phone: 9877665544</span>
                                    </div>
                                    <img class="img" src="{{ url_for('static', filename='img/footer/1.png') }}" alt="payment-image">
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                        <!-- Single Footer Start -->
                        <div class="col-lg-2  col-md-5 col-sm-6 footer-full">
                            <div class="single-footer">
                                <h3 class="footer-title">Information</h3>
                                <div class="footer-content">
                                    <ul class="footer-list">
                                        <li><a href="#">Site Map</a></li>
                                        <li><a href="#">Specials</a></li>
                                        <li><a href="#">Jobs</a></li>
                                        <li><a href="#">Delivery Information</a></li>
                                        <li><a href="#">Order History</a></li>
                                        <li><a href="#">Privacy Policy</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                        <!-- Single Footer Start -->
                        <div class="col-lg-2  col-md-4 col-md-4 col-sm-6 footer-full">
                            <div class="single-footer">
                                <h3 class="footer-title">My Account</h3>
                                <div class="footer-content">
                                    <ul class="footer-list">
                                        <li><a href="account.html">My account</a></li>
                                        <li><a href="#">Checkout</a></li>
                                        <li><a href="#">Login</a></li>
                                        <li><a href="#">address</a></li>
                                        <li><a href="#">Order status</a></li>
                                        <li><a href="#">Site Map</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                        <!-- Single Footer Start -->
                        <div class="col-lg-2 col-md-4 col-sm-6 footer-full">
                            <div class="single-footer">
                                <h3 class="footer-title">customer service</h3>
                                <div class="footer-content">
                                    <ul class="footer-list">
                                        <li><a href="account.html">My account</a></li>
                                        <li><a href="#">New</a></li>
                                        <li><a href="#">Gift Cards</a></li>
                                        <li><a href="#">Return Policy</a></li>
                                        <li><a href="#">Your Orders</a></li>
                                        <li><a href="#">Subway</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                        <!-- Single Footer Start -->
                        <div class="col-lg-2 col-md-4 col-sm-6 footer-full">
                            <div class="single-footer">
                                <h3 class="footer-title">Let Us Help You</h3>
                                <div class="footer-content">
                                    <ul class="footer-list">
                                        <li><a href="#">Your Account</a></li>
                                        <li><a href="#">Your Orders</a></li>
                                        <li><a href="#">Shipping</a></li>
                                        <li><a href="#">Amazon Prime</a></li>
                                        <li><a href="#">Replacements</a></li>
                                        <li><a href="#">Manage </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                    </div>
                    <!-- Row End -->
                </div>
                <!-- Container End -->
            </div>
            <!-- Footer Top End -->
            <!-- Footer Bottom Start -->
            <div class="footer-bottom off-white-bg2">
                <div class="container">
                    <div class="footer-bottom-content">
                        
                        <div class="footer-social-content">
                            <ul class="social-content-list">
                                <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                                <li><a href="#"><i class="fa fa-wifi"></i></a></li>
                                <li><a href="#"><i class="fa fa-google-plus"></i></a></li>
                                <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                                <li><a href="#"><i class="fa fa-youtube"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Container End -->
            </div>
            <!-- Footer Bottom End -->
        </footer>
        <!-- Footer End -->
    </div>
    <!-- Wrapper End -->
    <!-- jquery 3.12.4 -->
    <script src="{{ url_for('static', filename='js/vendor/jquery-1.12.4.min.js') }}"></script>
<!-- mobile menu js  -->
<script src="{{ url_for('static', filename='js/jquery.meanmenu.min.js') }}"></script>
<!-- scroll-up js -->
<script src="{{ url_for('static', filename='js/jquery.scrollUp.js') }}"></script>
<!-- owl-carousel js -->
<script src="{{ url_for('static', filename='js/owl.carousel.min.js') }}"></script>
<!-- slick js -->
<script src="{{ url_for('static', filename='js/slick.min.js') }}"></script>
<!-- wow js -->
<script src="{{ url_for('static', filename='js/wow.min.js') }}"></script>
<!-- price slider js -->
<script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.countdown.min.js') }}"></script>
<!-- nivo slider js -->
<script src="{{ url_for('static', filename='js/jquery.nivo.slider.js') }}"></script>
<!-- fancybox js -->
<script src="{{ url_for('static', filename='js/jquery.fancybox.min.js') }}"></script>
<!-- bootstrap -->
<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
<!-- plugins -->
<script src="{{ url_for('static', filename='js/plugins.js') }}"></script>
<!-- main js -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

<!-- Remove all other jQuery and Bootstrap imports and keep only these -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Add the return functionality JavaScript -->
<script>
$(document).ready(function() {
    // Use consistent class name
    $('.return-btn, .return-item').on('click', function(e) {
        e.preventDefault();
        console.log('Return button clicked');
        
        const orderId = $(this).data('order-id');
        const productName = $(this).data('product-name');
        const rentFrom = $(this).data('rent-from');
        const rentTo = $(this).data('rent-to');

        console.log('Order details:', { orderId, productName, rentFrom, rentTo });

        // Update modal content
        $('#returnProductName').text(productName);
        $('#returnRentFrom').text(rentFrom);
        $('#returnRentTo').text(rentTo);
        $('#confirmReturn').data('order-id', orderId);

        // Show modal
        $('#confirmReturnModal').modal('show');
    });

    // Confirm return button handler
    $('#confirmReturn').on('click', function() {
        const orderId = $(this).data('order-id');
        console.log('Confirming return for order:', orderId);
        
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Processing...');

        $.ajax({
            url: '/initiate-return',
            method: 'POST',
            contentType: 'application/json',  // Specify content type as JSON
            dataType: 'json',                // Expect JSON response
            data: JSON.stringify({           // Stringify the data
                order_id: orderId
            }),
            success: function(response) {
                console.log('Return response:', response);
                if (response.success) {
                    const returnModal = bootstrap.Modal.getInstance(document.getElementById('confirmReturnModal'));
                    returnModal.hide();
                    alert('Return initiated successfully');
                    location.reload();
                } else {
                    alert(response.error || 'Failed to initiate return');
                }
            },
            error: function(xhr, status, error) {
                console.error('Return error:', error);
                alert('Failed to initiate return. Please try again.');
            },
            complete: function() {
                $('#confirmReturn').prop('disabled', false).text('Confirm Return');
            }
        });
    });
});
</script>

<!-- Add complete modal structure -->
<div class="modal fade" id="confirmReturnModal" tabindex="-1" aria-labelledby="confirmReturnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReturnModalLabel">Confirm Return</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to return this item?</p>
                <p><strong>Product:</strong> <span id="returnProductName"></span></p>
                <p><strong>Rent From:</strong> <span id="returnRentFrom"></span></p>
                <p><strong>Rent To:</strong> <span id="returnRentTo"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmReturn">Confirm Return</button>
            </div>
        </div>
    </div>
</div>

<!-- More Details Modal -->
<div class="modal fade" id="moreDetailsModal" tabindex="-1" aria-labelledby="moreDetailsModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moreDetailsModalLabel">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading Spinner -->
                <div id="orderDetailsLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Error Alert -->
                <div id="orderDetailsError" class="alert alert-danger d-none" role="alert">
                    Failed to load order details. Please try again.
                </div>

                <!-- Order Content -->
                <div id="moreDetailsContent" class="d-none">
                    <!-- Order Progress Section -->
                    <div class="order-progress mb-4">
                        <h6 class="border-bottom pb-2">Order Progress</h6>
                        <div class="progress-track">
                            <div class="progress-steps">
                                <div class="step">
                                    <div class="step-icon">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                    <p class="step-text">Ordered</p>
                                    <small class="step-date"></small>
                                </div>
                                <div class="step">
                                    <div class="step-icon">
                                        <i class="fas fa-truck"></i>
                                    </div>
                                    <p class="step-text">In Transit</p>
                                    <small class="step-date"></small>
                                </div>
                                <div class="step">
                                    <div class="step-icon">
                                        <i class="fas fa-shipping-fast"></i>
                                    </div>
                                    <p class="step-text">Out for Delivery</p>
                                    <small class="step-date"></small>
                                </div>
                                <div class="step">
                                    <div class="step-icon">
                                        <i class="fas fa-box"></i>
                                    </div>
                                    <p class="step-text">Delivered</p>
                                    <small class="step-date"></small>
                                </div>
                                <div class="step">
                                    <div class="step-icon">
                                        <i class="fas fa-undo"></i>
                                    </div>
                                    <p class="step-text">Return Initiated</p>
                                    <small class="step-date"></small>
                                </div>
                                <div class="step">
                                    <div class="step-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <p class="step-text">Returned</p>
                                    <small class="step-date"></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Info Section -->
                    <div class="order-info mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Order ID:</strong> <span id="modalOrderId"></span></p>
                                <p><strong>Order Date:</strong> <span id="modalOrderDate"></span></p>
                                <p><strong>Total Amount:</strong> <span id="modalOrderTotal"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Shipping Address:</strong> <span id="modalShippingAddress"></span></p>
                                <p><strong>Payment ID:</strong> <span id="modalPaymentId"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Confirmation Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" role="dialog" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelOrderModalLabel">Cancel Order</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this order?</p>
                <p><strong>Order ID:</strong> <span id="cancelOrderId"></span></p>
                <p><strong>Product:</strong> <span id="cancelProductName"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">No, Keep Order</button>
                <button type="button" class="btn btn-danger" id="confirmCancelOrder">Yes, Cancel Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this modal for item cancellation -->
<div class="modal fade" id="cancelItemModal" tabindex="-1" role="dialog" aria-labelledby="cancelItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelItemModalLabel">Cancel Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this item?</p>
                <p><strong>Order ID:</strong> <span id="cancelItemOrderId"></span></p>
                <p><strong>Product:</strong> <span id="cancelItemProductName"></span></p>
                <div id="cancelQuantitySelector" style="display: none;">
                    <label for="cancelQuantity">Select quantity to cancel:</label>
                    <select id="cancelQuantity" class="form-control">
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">No, Keep Item</button>
                <button type="button" class="btn btn-danger" id="confirmCancelItem">Yes, Cancel Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Refund Notification Popup -->
<div id="refundNotification" class="position-fixed top-50 start-50 translate-middle bg-white p-4 rounded shadow-lg text-center" style="display: none; z-index: 9999;">
    <div class="mb-3">
        <i class="fa fa-check-circle text-success" style="font-size: 48px;"></i>
    </div>
    <h4>Refund Initiated</h4>
    <p>Your refund will be processed within 48 hours.</p>
</div>

<script>
$(document).ready(function() {
    // Initialize the modal
    const moreDetailsModal = new bootstrap.Modal(document.getElementById('moreDetailsModal'), {
        backdrop: true,
        keyboard: true
    });

    // View Order Details button click handler
    $('.view-order-details').on('click', function(e) {
        e.preventDefault();
        const orderId = $(this).data('order-id');
        console.log('Viewing order details for:', orderId);
        
        // Show modal
        moreDetailsModal.show();
        
        // Fetch order details
        fetchOrderDetails(orderId);
    });

    // Close button handlers for both the X and footer close button
    $('[data-bs-dismiss="modal"]').on('click', function() {
        moreDetailsModal.hide();
    });

    // Modal hidden event handler for cleanup
    $('#moreDetailsModal').on('hidden.bs.modal', function() {
        $('#moreDetailsContent').empty().addClass('d-none');
        $('#orderDetailsLoading').removeClass('d-none');
        $('#orderDetailsError').addClass('d-none');
    });

    // View Order Details functionality
    $('.view-order-details').on('click', function() {
        const orderId = $(this).data('order-id');
        fetchOrderDetails(orderId);
    });

    function fetchOrderDetails(orderId) {
        $.ajax({
            url: '/get-order-details',
            method: 'GET',
            data: { order_id: orderId },
            success: function(response) {
                if (response.success) {
                    populateMoreDetailsModal(response.order);
                } else {
                    console.error('Failed to fetch order details:', response.message);
                    showToast('Error', 'Failed to load order details. Please try again.', true);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching order details:', error);
                showToast('Error', 'An error occurred while loading order details.', true);
            }
        });
    }

    function populateMoreDetailsModal(order) {
        console.log('Populating modal with order:', order);

        // Reset previous content
        $('#moreDetailsContent').empty();

        // Get the first item
        const item = order.items[0];
        console.log('Item details:', item);

        // Create order details HTML with correct data mapping
        let detailsHtml = `
            <div class="order-info mt-4">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Order Details</h5>
                        <p><strong>Order ID:</strong> ${order.order_id}</p>
                        <p><strong>Order Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                        <p><strong>Product:</strong> ${item.product_name}</p>
                        <p><strong>Total Amount:</strong> ₹${order.order_total.toFixed(2)}</p>
                        <p><strong>Store:</strong> ${item.store_name}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Delivery Details</h5>
                        <p><strong>Shipping Address:</strong> ${order.shipping_address}</p>
                        <p><strong>Payment ID:</strong> ${order.payment_intent_id}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${getStatusBadgeColor(item.status)}">${item.status}</span></p>
                        <p><strong>Quantity:</strong> ${item.quantity}</p>
                        <p><strong>Rental Period:</strong> ${item.rent_from} to ${item.rent_to}</p>
                    </div>
                </div>
            </div>
        `;

        $('#moreDetailsContent').append(detailsHtml);

        // Update progress bar
        updateProgressBar(item);
    }

    function updateProgressBar(item) {
        console.log('Updating progress with item:', item);
        
        // Reset all steps
        const steps = $('.step');
        steps.removeClass('active completed');
        $('.step-date').text('');

        // Define the steps and their dates
        const orderSteps = [
            { status: 'ordered', date: item.ordered_at },
            { status: 'delivered', date: item.delivered_at },
            { status: 'return_initiated', date: item.return_initiated_at },
            { status: 'returned', date: item.return_completed_at }
        ];

        // Get current status index
        const currentStatus = item.status.toLowerCase();
        const currentStepIndex = orderSteps.findIndex(step => step.status === currentStatus);

        if (currentStepIndex !== -1) {
            // Update steps based on current status
            steps.each(function(index) {
                const $step = $(this);
                const stepData = orderSteps[index];

                if (index <= currentStepIndex) {
                    if (index < currentStepIndex) {
                        $step.addClass('completed');
                    } else {
                        $step.addClass('active');
                    }

                    // Add date if available
                    if (stepData.date) {
                        $step.find('.step-date').text(new Date(stepData.date).toLocaleString());
                    }
                }
            });
        }
    }

    function getStatusBadgeColor(status) {
        const colors = {
            'ordered': 'primary',
            'delivered': 'success',
            'return_initiated': 'warning',
            'returned': 'secondary',
            'cancelled': 'danger'
        };
        return colors[status?.toLowerCase()] || 'secondary';
    }

    // Add this function to generate and download the invoice
    function downloadInvoice(orderId) {
        // Get the order details from the modal
        const orderDetails = {
            orderId: orderId,
            storeName: $('#moreDetailsContent').find('.store-name').text(),
            gstNumber: $('#moreDetailsContent').find('.gst-number').text(),
            items: [],
            total: $('#moreDetailsContent').find('p:contains("Total Price")').text().split('₹')[1]
        };

        // Collect all items and their statuses
        $('#moreDetailsContent .list-group-item').each(function() {
            const item = {
                name: $(this).find('strong').text(),
                status: $(this).find('.badge').text(),
                quantity: $(this).text().match(/Quantity: (\d+)/)[1],
                price: $(this).text().match(/Price: ₹([\d.]+)/)[1],
                rentFrom: $(this).text().match(/Rent From: ([\d/]+)/)[1],
                rentTo: $(this).text().match(/Rent To: ([\d/]+)/)[1],
                storeName: $(this).find('.text-muted').text().replace('Store: ', '')
            };
            orderDetails.items.push(item);
        });

        // Send to server to generate PDF
        $.ajax({
            url: '/generate-invoice',
            method: 'POST',
            data: JSON.stringify(orderDetails),
            contentType: 'application/json',
            success: function(response) {
                // Create a blob from the PDF data
                const blob = new Blob([response], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice_${orderId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
            error: function(xhr, status, error) {
                showToast('Error', 'Failed to generate invoice', true);
            }
        });
    }

    function updateCancelButton(button, orderTime, cancelWindowMs, orderStatus) {
        const now = new Date();
        const timeSinceOrder = now - orderTime;
        const timeLeftMs = cancelWindowMs - timeSinceOrder;
        const orderId = button.data('order-id');

        if (timeLeftMs <= 0 || orderStatus.toLowerCase() === 'cancelled') {
            button.hide();
            $(`#download-invoice-${orderId}`).hide();
            if (orderStatus === 'paid') {
                $(`#return-button-${orderId}`).show();
            }
            updateEditOrderButtonVisibility(orderId);
            return;
        }

        const minutes = Math.floor(timeLeftMs / 60000);
        const seconds = Math.floor((timeLeftMs % 60000) / 1000);

        button.text(`Cancel Order (${minutes}:${seconds.toString().padStart(2, '0')})`);
        button.show();
        $(`#return-button-${orderId}`).hide();

        // Store the timer in a global variable
        window[`cancelTimer_${orderId}`] = setTimeout(() => {
            button.hide();
            updateEditOrderButtonVisibility(orderId);
            showToast('Info', `Cancellation window for Order #${orderId} has ended.`, false);
        }, timeLeftMs);
    }

    function updateEditOrderButtonVisibility(orderId) {
        const cancelButton = $(`#cancel-button-${orderId}`);
        const editButton = $(`.edit-order[data-order-id="${orderId}"]`);
        
        if (cancelButton.is(':visible')) {
            editButton.show();
        } else {
            editButton.hide();
        }
    }

    // Make sure to call updateCancelButton for each order when the page loads
    $(document).ready(function() {
        $('.cancel-order').each(function() {
            const button = $(this);
            const orderId = button.data('order-id');
            const orderTime = new Date(button.data('order-time'));
            const cancelWindowMs = 10 * 60 * 1000; // 10 minutes in milliseconds
            const orderStatus = button.data('order-status');
            
            updateCancelButton(button, orderTime, cancelWindowMs, orderStatus);
        });

        // ... rest of your existing code ...
    });

    $('.cancel-order').on('click', function() {
        const orderId = $(this).data('order-id');
        const productName = $(this).data('product-name');
        const orderTime = new Date($(this).data('order-time'));
        const cancelWindowMs = 10 * 60 * 1000; // 10 minutes in milliseconds
        const now = new Date();
        const timeSinceOrder = now - orderTime;

        if (timeSinceOrder <= cancelWindowMs) {
            $('#cancelOrderId').text(orderId);
            $('#cancelProductName').text(productName);
            $('#cancelOrderModal').modal('show');
        } else {
            showToast('Error', 'The cancellation window for this order has expired.', true);
        }
    });

    $('#confirmCancelOrder').on('click', function() {
        const orderId = $('#cancelOrderId').text();
        cancelOrder(orderId);
    });

    function cancelOrder(orderId) {
        $.ajax({
            url: '/cancel-order',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ order_id: orderId }),
            success: function(response) {
                if (response.success) {
                    showToast('Success', 'Order cancelled successfully', false);
                    updateOrderStatus(orderId, 'Cancelled');
                    // Immediately hide buttons without waiting for updateCancelButton
                    $(`#cancel-button-${orderId}`).hide();
                    $(`#download-invoice-${orderId}`).hide();
                    $(`#return-button-${orderId}`).hide();
                    // Stop the cancel button timer
                    clearTimeout(window[`cancelTimer_${orderId}`]);
                } else {
                    showToast('Error', 'Failed to cancel order: ' + response.message, true);
                }
                $('#cancelOrderModal').modal('hide');
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showToast('Error', 'An error occurred while cancelling the order', true);
                $('#cancelOrderModal').modal('hide');
            }
        });
    }

    // Add this to your existing JavaScript
    $(document).ready(function() {
        // ... existing code ...

        $('.cancel-item').on('click', function() {
            const orderId = $(this).data('order-id');
            const productId = $(this).data('product-id');
            const productName = $(this).data('product-name');
            const quantity = $(this).data('quantity');

            // Populate modal
            $('#cancelItemOrderId').text(orderId);
            $('#cancelItemProductName').text(productName);

            // Show quantity selector if quantity > 1
            if (quantity > 1) {
                $('#cancelQuantitySelector').show();
                const $quantitySelect = $('#cancelQuantity');
                $quantitySelect.empty();
                for (let i = 1; i <= quantity; i++) {
                    $quantitySelect.append($('<option>', {
                        value: i,
                        text: i
                    }));
                }
            } else {
                $('#cancelQuantitySelector').hide();
            }

            // Store data for use in confirmCancelItem
            $('#confirmCancelItem').data('order-id', orderId).data('product-id', productId);

            // Show modal
            $('#cancelItemModal').modal('show');
        });

        $('#confirmCancelItem').on('click', function() {
            const orderId = $(this).data('order-id');
            const productId = $(this).data('product-id');
            const cancelQuantity = $('#cancelQuantity').is(':visible') ? parseInt($('#cancelQuantity').val()) : 1;
            cancelOrderItem(orderId, productId, cancelQuantity);
        });

        function cancelOrderItem(orderId, productId, quantity) {
            $.ajax({
                url: '/cancel-order-item',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ order_id: orderId, product_id: productId, quantity: quantity }),
                success: function(response) {
                    if (response.success) {
                        showToast('Success', 'Item cancelled successfully', false);
                        updateItemStatus(orderId, productId, response.newStatus, quantity, response.remainingQuantity);
                        
                        // Update the quantity displayed in the order
                        $(`#item-quantity-${orderId}-${productId}`).text(response.remainingQuantity);
                        
                        // Update the cancel button's data-quantity attribute
                        $(`#cancel-button-${orderId}-${productId}`).data('quantity', response.remainingQuantity);
                        
                        // Update the order total
                        if (response.newOrderTotal !== undefined) {
                            $(`#order-total-${orderId}`).text(`₹${response.newOrderTotal.toFixed(2)}`);
                        }

                        // Show refund notification
                        showRefundNotification();
                    } else {
                        showToast('Error', 'Failed to cancel item: ' + response.message, true);
                    }
                    $('#cancelItemModal').modal('hide');
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    showToast('Error', 'An error occurred while cancelling the item', true);
                    $('#cancelItemModal').modal('hide');
                }
            });
        }

        function updateItemStatus(orderId, productId, newStatus, cancelledQuantity, remainingQuantity) {
            const statusCell = $(`#status-cell-${orderId}-${productId}`);
            let statusHtml = '';
            if (newStatus === 'cancelled') {
                statusHtml = `
                    <span class="badge bg-danger">Cancelled</span><br>
                    <small>Cancelled on: <span class="cancelled-date">${new Date().toISOString().split('T')[0]}</span></small>
                `;
            } else if (newStatus === 'partially_cancelled') {
                statusHtml = `
                    <span class="badge bg-warning">Partially Cancelled</span><br>
                    <small>Cancelled: ${cancelledQuantity}, Remaining: ${remainingQuantity}</small><br>
                    <small>Last update: <span class="cancelled-date">${new Date().toISOString().split('T')[0]}</span></small>
                `;
            }
            statusCell.html(statusHtml);

            // Disable the cancel button if the item is fully cancelled
            if (newStatus === 'cancelled' || remainingQuantity === 0) {
                $(`#cancel-button-${orderId}-${productId}`).prop('disabled', true);
            }
        }

        // ... rest of your existing code ...
    });

    // Add this new function to handle the refund notification
    function showRefundNotification() {
        const $notification = $('#refundNotification');
        
        // Show the notification with fade effect
        $notification.fadeIn(300);
        
        // Hide the notification after 3 seconds with fade effect
        setTimeout(() => {
            $notification.fadeOut(300);
        }, 3000);
    }

    // Initialize countdown for each cancel button
    $('.cancel-item').each(function() {
        const button = $(this);
        const orderTime = new Date(button.data('order-time'));
        const now = new Date();
        const timeSinceOrder = now - orderTime;
        const cancelWindowMs = 10 * 60 * 1000;
        
        if (timeSinceOrder <= cancelWindowMs) {
            // Start countdown
            updateCancelButtonTimer(button, orderTime);
        } else {
            // Hide button if more than 10 minutes have passed
            button.hide();
        }
    });

    function updateCancelButtonTimer(button, orderTime) {
        const updateTimer = () => {
            const now = new Date();
            const timeSinceOrder = now - orderTime;
            const cancelWindowMs = 10 * 60 * 1000;
            const timeLeftMs = cancelWindowMs - timeSinceOrder;
            
            if (timeLeftMs <= 0) {
                // Time's up - hide cancel button
                button.hide();
                clearInterval(timerInterval);
            } else {
                // Update button text with countdown
                const minutes = Math.floor(timeLeftMs / 60000);
                const seconds = Math.floor((timeLeftMs % 60000) / 1000);
                button.html(`<i class="fa fa-times"></i> Cancel (${minutes}:${seconds.toString().padStart(2, '0')})`);
            }
        };

        // Update immediately and then every second
        updateTimer();
        const timerInterval = setInterval(updateTimer, 1000);
        
        // Store the interval ID on the button element for cleanup
        button.data('timerInterval', timerInterval);
    }

    // Handle button click
    $('.cancel-item').on('click', function() {
        const button = $(this);
        const orderTime = new Date(button.data('order-time'));
        const now = new Date();
        const timeSinceOrder = now - orderTime;
        const cancelWindowMs = 10 * 60 * 1000;

        if (timeSinceOrder > cancelWindowMs) {
            showToast('Error', 'Cancel window has expired', true);
            button.hide();
            return;
        }

        // Your existing cancel logic here
        const orderId = button.data('order-id');
        const productId = button.data('product-id');
        const productName = button.data('product-name');
        const quantity = button.data('quantity');

        // Show cancel confirmation modal
        $('#cancelItemOrderId').text(orderId);
        $('#cancelItemProductName').text(productName);
        $('#cancelItemModal').modal('show');
    });

    // Cleanup intervals when the page is unloaded
    $(window).on('unload', function() {
        $('.cancel-item').each(function() {
            const interval = $(this).data('timerInterval');
            if (interval) {
                clearInterval(interval);
            }
        });
    });

    // Return button click handler
    $('.return-item').on('click', function(e) {
        e.preventDefault();
        const button = $(this);
        const orderId = button.attr('data-order-id'); // Changed from data() to attr()
        console.log('Return button clicked for order:', orderId);

        // Update modal and show it
        $('#confirmReturn').attr('data-order-id', orderId); // Changed from data() to attr()
        const returnModal = new bootstrap.Modal(document.getElementById('confirmReturnModal'));
        returnModal.show();
    });

    // Confirm return button click handler
    $('#confirmReturn').on('click', function() {
        const orderId = $(this).attr('data-order-id'); // Changed from data() to attr()
        console.log('Confirming return for order ID:', orderId);

        // Disable button and show loading
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Processing...');

        // Make the AJAX call
        $.ajax({
            url: '/initiate-return',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ order_id: orderId }),
            success: function(response) {
                console.log('Server response:', response);
                if (response.success) {
                    console.log('Return initiated successfully');
                    $('#confirmReturnModal').modal('hide');
                    alert('Return initiated successfully');
                    location.reload();
                } else {
                    console.error('Server returned error:', response.error);
                    alert(response.error || 'Failed to initiate return');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', {status, error, responseText: xhr.responseText});
                alert('Failed to initiate return. Please try again.');
            },
            complete: function() {
                $('#confirmReturn').prop('disabled', false).text('Confirm Return');
            }
        });
    });
});

// Click handler for the "More Details" button
$(document).ready(function() {
    $('.view-order-details').on('click', function(e) {
        e.preventDefault();
        const orderId = $(this).data('order-id');
        console.log('Button clicked, Order ID:', orderId); // Debug log
        showOrderDetails(orderId);
    });
});

function showOrderDetails(orderId) {
    console.log('showOrderDetails called with ID:', orderId); // Debug log
    
    // Show loading spinner, hide content and error
    $('#orderDetailsLoading').removeClass('d-none');
    $('#moreDetailsContent').addClass('d-none');
    $('#orderDetailsError').addClass('d-none');
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('moreDetailsModal'));
    modal.show();

    // Make sure orderId exists before making the request
    if (!orderId) {
        console.error('No order ID provided');
        $('#orderDetailsLoading').addClass('d-none');
        $('#orderDetailsError').removeClass('d-none').text('No order ID provided');
        return;
    }

    // Fetch order details
    $.ajax({
        url: '/get-order-details',
        method: 'GET',
        data: { order_id: orderId },
        success: function(response) {
            console.log('Response received:', response); // Debug log
            
            if (response) {
                // Update basic order info
                $('#modalOrderId').text(orderId);
                $('#modalOrderDate').text(new Date(response.created_at).toLocaleString());
                $('#modalOrderTotal').text(`₹${response.order_total}`);
                $('#modalShippingAddress').text(response.shipping_address);
                $('#modalPaymentId').text(response.payment_intent_id);

                // Update items table
                let itemsHtml = '';
                if (response.items && Array.isArray(response.items)) {
                    response.items.forEach(item => {
                        itemsHtml += `
                            <tr>
                                <td>${item.product_name || item.product_id}</td>
                                <td>${item.quantity}</td>
                                <td>${item.rent_from} to ${item.rent_to}</td>
                                <td>
                                    <span class="badge bg-${getStatusBadgeColor(item.status)}">
                                        ${item.status}
                                    </span>
                                </td>
                                <td>₹${item.total_price}</td>
                            </tr>
                        `;
                    });
                }
                $('#orderItemsTable').html(itemsHtml);

                // Update progress steps
                updateOrderProgress(response);

                // Hide loading, show content
                $('#orderDetailsLoading').addClass('d-none');
                $('#moreDetailsContent').removeClass('d-none');
            } else {
                throw new Error('No data received from server');
            }
        },
        error: function(xhr, status, error) {
            console.error('Ajax error:', error); // Debug log
            console.error('Status:', status);
            console.error('Response:', xhr.responseText);
            
            $('#orderDetailsLoading').addClass('d-none');
            $('#orderDetailsError').removeClass('d-none')
                .text('Failed to load order details: ' + error);
        }
    });
}

function updateOrderProgress(order) {
    console.log('Updating progress with:', order); // Debug log
    const steps = $('.step');
    let currentStep = 0;

    // Reset all steps
    steps.removeClass('active completed');

    // Determine current step and update progress
    if (order.ordered_at || order.created_at) {
        currentStep = 1;
        updateStep(0, order.ordered_at || order.created_at);
    }
    if (order.delivery_started_at) {
        currentStep = 2;
        updateStep(1, order.delivery_started_at);
    }
    if (order.delivery_completed_at) {
        currentStep = 3;
        updateStep(2, order.delivery_completed_at);
    }
    if (order.return_initiated_at) {
        currentStep = 4;
        updateStep(3, order.return_initiated_at);
    }
    if (order.return_completed_at) {
        currentStep = 5;
        updateStep(4, order.return_completed_at);
    }

    // Update step classes
    steps.each(function(index) {
        if (index < currentStep) {
            $(this).addClass('completed');
        } else if (index === currentStep) {
            $(this).addClass('active');
        }
    });
}

function updateStep(stepIndex, date) {
    const dateElement = $('.step-date').eq(stepIndex);
    if (date) {
        dateElement.text(new Date(date).toLocaleString());
    }
}

function getStatusBadgeColor(status) {
    const colors = {
        'ordered': 'primary',
        'in_transit': 'info',
        'delivered': 'success',
        'return_initiated': 'warning',
        'returned': 'secondary',
        'cancelled': 'danger',
        'paid': 'success'
    };
    return colors[status?.toLowerCase()] || 'secondary';
}
</script>
                     
</body>


<!-- Mirrored from htmldemo.net/jantrik/jantrik/account.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 05 Jul 2024 04:21:12 GMT -->
</html>
