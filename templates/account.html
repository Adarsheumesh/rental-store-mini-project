<!doctype html>
<html class="no-js" lang="en-US">


<!-- Mirrored from htmldemo.net/jantrik/jantrik/account.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 05 Jul 2024 04:21:11 GMT -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Account || Jantrik Bootstrap5 Template for Tools, Equipment Store</title>
    <meta name="description" content="Default Description">
    <meta name="keywords" content="E-commerce" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- place favicon.ico in the root directory -->
   <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='img/icon/favicon.png') }}">

   <!-- Google Font css -->
   <link href="http://fonts.googleapis.com/css?family=Lily+Script+One" rel="stylesheet"> 

 <!-- mobile menu css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/meanmenu.min.css') }}">
 <!-- animate css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}">
 <!-- nivo slider css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/nivo-slider.css') }}">
 <!-- owl carousel css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.carousel.min.css') }}">
 <!-- slick css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/slick.css') }}">
 <!-- price slider css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui.min.css') }}">
 <!-- fontawesome css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
 <!-- fancybox css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.fancybox.css') }}">
 <!-- bootstrap css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
 <!-- default css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/default.css') }}">
 <!-- style css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
 <!-- responsive css -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">

 <!-- modernizr js -->
 <script src="{{ url_for('static', filename='js/vendor/modernizr-2.8.3.min.js') }}"></script>
 
    <style>
        .user-account-dropdown {
            position: relative;
        }

        .user-account-dropdown .user-toggle {
            color: #2874f0;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            padding: 8px 12px;
            background-color: #fff;
            border-radius: 2px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .user-account-dropdown .user-toggle:hover {
            background-color: #f0f0f0;
        }

        .user-account-dropdown .user-toggle i {
            margin-right: 5px;
        }

        .user-account-dropdown .ht-dropdown.user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            display: none;
            z-index: 1000;
            min-width: 200px;
            padding: 5px 0;
        }

        .user-account-dropdown:hover .ht-dropdown.user-menu {
            display: block;
        }

        .user-account-dropdown .ht-dropdown.user-menu li {
            list-style: none;
        }

        .user-account-dropdown .ht-dropdown.user-menu a {
            display: block;
            padding: 10px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .user-account-dropdown .ht-dropdown.user-menu a:hover {
            background-color: #f5f5f5;
            color: #2874f0;
        }

        .user-account-dropdown .ht-dropdown.user-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .user-account-dropdown .ht-dropdown.user-menu .divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 5px 0;
        }

        #refundNotification {
            min-width: 300px;
            max-width: 400px;
            border: 1px solid #ddd;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            animation: fadeInOut 5s ease-in-out;
            background-color: #fff;
            z-index: 9999;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        #refundNotification .fa-check-circle {
            color: #28a745;
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        #refundNotification h4 {
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        #refundNotification p {
            color: #555;
            margin-bottom: 5px;
        }

        .order-progress {
            margin: 2rem 0;
            position: relative;
        }

        .progress-track {
            margin: 30px 0;
            position: relative;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            width: 20%;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step.active .step-icon {
            border-color: #007bff;
            background: #007bff;
            color: #fff;
        }

        .step.completed .step-icon {
            border-color: #28a745;
            background: #28a745;
            color: #fff;
        }

        .step-text {
            font-size: 12px;
            margin: 5px 0;
        }

        .step-date {
            font-size: 11px;
            color: #666;
        }

        .progress-fill {
            height: 3px;
            background: #4e73df;
            width: 0;
            transition: width 0.5s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .progress-label {
            text-align: center;
            position: relative;
            width: 16.66%; /* Updated for 6 steps */
        }

        .progress-label.active {
            color: #4e73df;
            font-weight: 600;
        }

        .progress-label.completed {
            color: #1cc88a;
            font-weight: 600;
        }
    </style>
    <style>
       
        
        .toolhive-logo {
            text-decoration: none;
            display: block;
            padding: 10px 0;
        }
    
        .logo-text {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            font-family: 'Lily Script One', cursive;
        }
    
        .logo-text .highlight {
            color: #ff6a00;
        }
    
        @media (max-width: 768px) {
            .logo-text {
                font-size: 24px;
            }
        }
    </style>

    <!-- Update the modal HTML -->
    <style>
        /* Remove modal backdrop */
        .modal-backdrop {
            display: none !important;
        }
        
        /* Ensure modal is visible without backdrop */
        .modal {
            background: transparent !important;
        }
        
        /* Optional: Add a subtle box shadow to make modal stand out */
        .modal-content {
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
    </style>

    <!-- Add this CSS in the head section -->
    <style>
        .timeline-events {
            position: relative;
            padding: 20px 0;
        }

        .timeline-events::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }

        .timeline-event {
            position: relative;
            padding-left: 45px;
            margin-bottom: 20px;
        }

        .timeline-icon {
            position: absolute;
            left: 0;
            width: 32px;
            height: 32px;
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .timeline-content {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 4px;
        }

        .timeline-date {
            font-size: 0.875rem;
            color: #666;
        }

        .timeline-label {
            font-weight: 500;
        }

        #returnDetailsModal .modal-content {
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        #returnDetailsModal .modal-body {
            padding: 20px;
        }

        #returnDetailsModal h6 {
            color: #333;
            margin-bottom: 15px;
        }

        #returnDetailsModal .badge {
            padding: 0.5em 0.75em;
        }
    </style>
</head>

<body>
    <!--[if lt IE 8]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <!-- Wrapper Start -->
    <div class="wrapper">
        <!-- Header Area Start -->
        <header>
            <!-- Header Top Start -->
            
            <!-- Header Top End -->
            <!-- Header Bottom Start -->
            <div class="header-bottom header-sticky">
                <div class="container">
                    <div class="row justify-content-between">
                        <!--  logo Start-->
                        <div class="col-auto">
                            <div class="logo">
                                <a href="/index" class="toolhive-logo">
                                    <span class="logo-text">Tool<span class="highlight">Hive</span></span>
                                </a>
                            </div>                          
                        </div>
                       <!--  logo End -->

                        <!--  Desktop Memu Start -->
                        
                        <!--  Desktop Memu End -->
                        
                        <!--  Cartt Box  Start -->
                        <div class="col-auto">
                            <div class="cart-box text-end">
                                <ul>
                                    <li class="user-account-dropdown">
                                        <a href="#" class="user-toggle">
                                            <i class="fa fa-user-circle"></i> Hello, {{ user_info.name }} <i class="fa fa-angle-down"></i>
                                        </a>
                                        <ul class="ht-dropdown user-menu">
                                            <li><a href="/account"><i class="fa fa-user"></i> My Account</a></li>
                                            <li><a href="/wishlist"><i class="fa fa-heart"></i> Wishlist</a></li>
                                            <li class="divider"></li>
                                            <li><a href="/logout"><i class="fa fa-sign-out"></i> Logout</a></li>
                                        </ul>
                                    </li>                                    
                                    <li><a href="#" data-bs-toggle="modal" data-bs-target="#walletModal"><i class="fa fa-credit-card"></i></a></li>
                                    <li><a href="/wishlist"><i class="fa fa-heart-o"></i></a></li>
                                    <li>
                                        <a href="/cart">
                                            <i class="fa fa-shopping-basket"></i>
                                            <span class="cart-counter">{{ cart_count }}</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!--  Cartt Box  End-->
                       
                        <!-- Mobile Menu  End -->                        
                    </div>
                    <!-- Row End -->
                </div>
                <!-- Container End -->
            </div>
            <!-- Header Bottom End -->
        </header>
        <!-- Header Area End -->
        <!-- Breadcrumb Start -->
        <div class="breadcrumb-area ptb-60 ptb-sm-30">
            <div class="container">
                <div class="breadcrumb">
                    <ul>
                        <li><a href="/index">Home</a></li>
                        <li class="active"><a href="/account">Account</a></li>
                    </ul>
                </div>
            </div>
            <!-- Container End -->
        </div>
        <!-- Breadcrumb End -->
        <!-- My Account Page Start Here -->
        <div class="my-account white-bg pb-60">
            <div class="container">
                <div class="account-dashboard">
                   
                   <div class="row">
                    <div class="col-lg-2">
                        <!-- Nav tabs -->
                        <ul class="nav flex-column dashboard-list" role="tablist">
                            <li><a class="active" data-bs-toggle="tab" href="#account-details">Account details</a></li>
                            <li><a data-bs-toggle="tab" href="#orders">Orders</a></li>
                            <!-- Add new Returns tab -->
                            <li><a data-bs-toggle="tab" href="#returns">Returns</a></li>
                            <li><a data-bs-toggle="tab" href='#edit-account-details'>Edit Account details</a></li>
                            <li><a href="/logout">logout</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-10">
                        <!-- Tab panes -->
                        <div class="tab-content dashboard-content mt-all-40">
                            <div id="account-details" class="tab-pane active">
                                <h3>Account details </h3>
                                <div class="register-form login-form clearfix">
                                    <form action="#">
                                        <div class="form-group row">
                                            <label for="f-name" class="col-lg-3 col-md-4 col-form-label">Name</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label>{{ user_info.name }}</label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="l-name" class="col-lg-3 col-md-4 col-form-label">District</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label>{{ user_info.district }} </label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="address" class="col-lg-3 col-md-4 col-form-label">Address</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label style="white-space: pre-line;">{{ user_info.address }}</label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="email" class="col-lg-3 col-md-4 col-form-label">Email address</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label>{{ user_info.email }} </label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="inputpassword" class="col-lg-3 col-md-4 col-form-label">Phone No</label>
                                            <div class="col-lg-6 col-md-8">
                                                <label>{{ user_info.phone }} </label>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div id="orders" class="tab-pane fade">
                                <h3>Orders</h3>
                                <div class="order-history-container">
                                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                        <table class="table">
                                            <tbody>
                                                {% for order in orders %}
                                                    <tr>
                                                        <td colspan="5">
                                                            <strong>Order ID: {{ order.get('order_id', 'N/A') }}</strong><br>
                                                            Total Price: ₹{{ "%.2f"|format(order.get('subtotal', 0)) }}<br>
                                                            Order Date: {{ order.get('created_at', 'N/A') }}
                                                        </td>
                                                    </tr>
                                                    {% for item in order.get('items', []) %}
                                                    <tr id="item-row-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}">
                                                        <td>
                                                            <img src="{{ item.get('image_url', url_for('static', filename='img/default-product.jpg')) }}" 
                                                                 alt="{{ item.get('product_name', 'Product') }}" width="50" height="50">
                                                        </td>
                                                        <td>
                                                            <strong>{{ item.get('product_name', 'Unknown Product') }}</strong><br>
                                                            {% if item.get('color') %}Color: {{ item.get('color') }}{% endif %}
                                                            {% if item.get('size') %}Size: {{ item.get('size') }}{% endif %}
                                                            <br>
                                                            Quantity: <span id="item-quantity-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}">{{ item.get('quantity', 1) }}</span>
                                                        </td>
                                                        <td></td>
                                                        <td id="status-cell-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}">
                                                            {% if item.get('status') == 'cancelled' %}
                                                                <span class="badge bg-danger">Cancelled</span><br>
                                                                <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                    
                                                            {% elif item.get('status') == 'partially_cancelled' %}
                                                                <span class="badge bg-warning text-dark">Partially Cancelled</span><br>
                                                                <small>Cancelled: {{ item.get('cancelled_quantity', 'N/A') }}, Remaining: {{ item.get('quantity', 'N/A') }}</small>
                                                    
                                                            {% elif item.get('status') == 'returned' %}
                                                                <span class="badge bg-success">Returned</span><br>
                                                                <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                    
                                                            {% elif item.get('status') == 'return_initiated' %}
                                                                <span class="badge bg-warning text-dark">Return Initiated</span><br>
                                                                <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                    
                                                            {% else %}
                                                                <span class="badge bg-primary">Active</span><br>
                                                                <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                            {% endif %}
                                                            <br>
                                                            <small>Quantity: {{ item.get('quantity', 'N/A') }} | Days: {{ item.get('rental_days', 'N/A') }}</small>
                                                        </td>
                                                        <td class="product-add-to-cart">
                                                            <div class="d-flex flex-column gap-2">
                                                                {% if item.get('status') == 'ordered' or item.get('status') == 'partially_cancelled' %}
                                                                    <!-- Cancel Button (show for first 10 minutes when status is ordered or partially_cancelled) -->
                                                                    <button class="btn btn-outline-danger btn-sm cancel-item" 
                                                                            id="cancel-button-{{ order.get('order_id', '') }}-{{ item.get('product_id', '') }}"
                                                                            data-order-id="{{ order.get('order_id', '') }}"
                                                                            data-product-id="{{ item.get('product_id', '') }}"
                                                                            data-product-name="{{ item.get('product_name', '') }}"
                                                                            data-order-time="{{ order.get('created_at', '') }}"
                                                                            data-quantity="{{ item.get('quantity', 1) }}">
                                                                        <i class="fa fa-times"></i> Cancel{% if item.get('status') == 'partially_cancelled' %} Remaining{% endif %}
                                                                    </button>
                                                                {% elif item.get('status') == 'delivered' %}
                                                                    <!-- Return Button (show when status is delivered) -->
                                                                    <button type="button" 
                                                                            class="btn btn-sm btn-warning return-item"
                                                                            data-order-id="{{ order.get('order_id', '') }}"
                                                                            data-product-id="{{ item.get('product_id', '') }}"
                                                                            data-product-name="{{ item.get('product_name', '') }}"
                                                                            data-rent-from="{{ item.get('rent_from', '') }}"
                                                                            data-rent-to="{{ item.get('rent_to', '') }}"
                                                                            data-quantity="{{ item.get('quantity', 1) }}">
                                                                        Return
                                                                    </button>
                                                                    <!-- Extend Rental Button -->
                                                                    <button class="btn btn-sm btn-primary" 
                                                                            onclick="handleExtendRental(this)"
                                                                            data-order-id="{{ order.get('order_id', '') }}"
                                                                            data-item-index="{{ loop.index0 }}"
                                                                            data-item='{{ item|tojson|safe }}'
                                                                            data-wallet-deposit="{{ order.get('wallet_deposit', 0) }}">
                                                                        <i class="fa fa-calendar-plus"></i>
                                                                        Extend Rental
                                                                    </button>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                    <tr>
                                                        <td colspan="5">
                                                            <strong>Total: </strong><span id="order-total-{{ order.get('order_id', '') }}">₹{{ "%.2f"|format(order.get('subtotal', 0)) }}</span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="6">
                                                            <div class="d-flex flex-column align-items-start">
                                                                <div class="btn-group-vertical w-100 mb-2" role="group">
                                                                    <button class="btn btn-outline-primary btn-sm view-order-details" 
                                                                            data-order-id="{{ order.get('order_id', '') }}">
                                                                        <i class="fa fa-eye"></i> View Details
                                                                    </button>
                                                                    <!-- All download invoice buttons removed -->
                                                                </div>
                                                                
                                                                {% if order.get('status') != 'cancelled' %}
                                                                    <div class="btn-group w-100" role="group">
                                                                        {% set all_items_returned = true %}
                                                                        {% for item in order.get('items', []) %}
                                                                            {% if item.get('status') != 'returned' %}
                                                                                {% set all_items_returned = false %}
                                                                            {% endif %}
                                                                        {% endfor %}

                                                                        {% if all_items_returned %}
                                                                            <!-- Download Invoice Button (when all items are returned) -->
                                                                           
                                                                        {% else %}
                                                                            {% for item in order.get('items', []) %}
                                                                                {% if item.get('status') != 'returned' %}
                                                                                    <!-- Return Button (for non-returned items) -->
                                                                                    <button type="button" 
                                                                                            class="btn btn-warning return-item" 
                                                                                            data-order-id="{{ order.get('order_id') }}"
                                                                                            data-product-id="{{ item.get('product_id') }}"
                                                                                            data-product-name="{{ item.get('product_name') }}"
                                                                                            data-rent-from="{{ item.get('rent_from') }}"
                                                                                            data-rent-to="{{ item.get('rent_to') }}"
                                                                                            data-quantity="{{ item.get('quantity', 1) }}">
                                                                                        Return
                                                                                    </button>
                                                                                {% endif %}
                                                                            {% endfor %}
                                                                        {% endif %}

                                                                        
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="5"><hr></td>
                                                    </tr>
                                                {% else %}
                                                <tr>
                                                    <td colspan="5">No orders found.</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            
                          
                            <div id="edit-account-details" class="tab-pane fade">
                                <h3>Edit Account details </h3>
                                <div class="register-form login-form clearfix">
                                    <form action="{{ url_for('update_account') }}" method="POST" onsubmit="return validateForm()">
                                        <div class="form-group row">
                                            <label for="f-name" class="col-lg-3 col-md-4 col-form-label">Name</label>
                                            <div class="col-lg-6 col-md-8">
                                                <input type="text" class="form-control" id="f-name" name="name" value="{{ user_info.name }}" required oninput="validateName()">
                                                <div id="nameError" style="color: red;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="l-name" class="col-lg-3 col-md-4 col-form-label">District</label>
                                            <div class="col-lg-6 col-md-8">
                                                <select class="form-control" id="l-name" name="district" required onchange="validateDistrict()">
                                                    <option value="">Select your district</option>
                                                    <option value="Alappuzha" {% if user_info.district == 'Alappuzha' %}selected{% endif %}>Alappuzha</option>
                                                    <option value="Ernakulam" {% if user_info.district == 'Ernakulam' %}selected{% endif %}>Ernakulam</option>
                                                    <option value="Idukki" {% if user_info.district == 'Idukki' %}selected{% endif %}>Idukki</option>
                                                    <option value="Kannur" {% if user_info.district == 'Kannur' %}selected{% endif %}>Kannur</option>
                                                    <option value="Kasaragod" {% if user_info.district == 'Kasaragod' %}selected{% endif %}>Kasaragod</option>
                                                    <option value="Kollam" {% if user_info.district == 'Kollam' %}selected{% endif %}>Kollam</option>
                                                    <option value="Kottayam" {% if user_info.district == 'Kottayam' %}selected{% endif %}>Kottayam</option>
                                                    <option value="Kozhikode" {% if user_info.district == 'Kozhikode' %}selected{% endif %}>Kozhikode</option>
                                                    <option value="Malappuram" {% if user_info.district == 'Malappuram' %}selected{% endif %}>Malappuram</option>
                                                    <option value="Palakkad" {% if user_info.district == 'Palakkad' %}selected{% endif %}>Palakkad</option>
                                                    <option value="Pathanamthitta" {% if user_info.district == 'Pathanamthitta' %}selected{% endif %}>Pathanamthitta</option>
                                                    <option value="Thiruvananthapuram" {% if user_info.district == 'Thiruvananthapuram' %}selected{% endif %}>Thiruvananthapuram</option>
                                                    <option value="Thrissur" {% if user_info.district == 'Thrissur' %}selected{% endif %}>Thrissur</option>
                                                    <option value="Wayanad" {% if user_info.district == 'Wayanad' %}selected{% endif %}>Wayanad</option>
                                                </select>
                                                <div id="districtError" style="color: red;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="address" class="col-lg-3 col-md-4 col-form-label">Address</label>
                                            <div class="col-lg-6 col-md-8">
                                                <textarea class="form-control" id="address" name="address" rows="3" required oninput="validateAddress()">{{ user_info.address }}</textarea>
                                                <div id="addressError" style="color: red;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="phone" class="col-lg-3 col-md-4 col-form-label">Phone No</label>
                                            <div class="col-lg-6 col-md-8">
                                                <input type="tel" class="form-control" id="phone" name="phone" value="{{ user_info.phone }}" required oninput="validatePhone()">
                                                <div id="phoneError" style="color: red;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <div class="col-lg-6 col-md-8">
                                                <button type="submit" class="btn btn-primary">Update</button>
                                            </div>
                                        </div>
                                    </form>
                
                                    {% with messages = get_flashed_messages(with_categories=true) %}
                                    {% if messages %}
                                        {% for category, message in messages %}
                                            <div class="alert alert-{{ category }}">
                                                {{ message }}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                    {% endwith %}

                                </div>
                            </div>
                            
                            <!-- New Returns tab content -->
                            <div id="returns" class="tab-pane fade">
                                <h3>Returns</h3>
                                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                    <table class="table">
                                        <thead style="position: sticky; top: 0; background-color: white; z-index: 1;">
                                            <tr>
                                                <th>Product</th>
                                                <th>Details</th>
                                                <th>Price</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for order in orders %}
                                                {% for item in order.get('items', []) %}
                                                    {% if item.get('status') == 'returned' %}
                                                        <tr>
                                                            <td>
                                                                <img src="{{ item.get('image_url', url_for('static', filename='img/default-product.jpg')) }}" 
                                                                     alt="{{ item.get('product_name', 'Product') }}" 
                                                                     width="50" height="50">
                                                            </td>
                                                            <td>
                                                                <strong>{{ item.get('product_name', 'Unknown Product') }}</strong><br>
                                                                Order ID: {{ order.get('order_id', 'N/A') }}<br>
                                                                {% if item.get('color') %}Color: {{ item.get('color') }}{% endif %}
                                                                {% if item.get('size') %}Size: {{ item.get('size') }}{% endif %}
                                                                <br>
                                                                Quantity: {{ item.get('quantity', 1) }}
                                                            </td>
                                                            <td>₹{{ "%.2f"|format(item.get('total_price', 0)) }}</td>
                                                            <td>
                                                                <span class="badge bg-success">Returned</span><br>
                                                                <small>Return Date: {{ item.get('return_completed_at', 'N/A') }}</small><br>
                                                                <small>Rental Period: {{ item.get('rent_from', 'N/A') }} to {{ item.get('rent_to', 'N/A') }}</small>
                                                            </td>
                                                            <td>
                                                                <div class="d-flex flex-column gap-2">
                                                                    <button class="btn btn-outline-primary btn-sm view-return-details" 
                                                                            data-order-id="{{ order.get('order_id', '') }}"
                                                                            data-product-id="{{ item.get('product_id', '') }}">
                                                                        <i class="fa fa-eye"></i> View Details
                                                                    </button>
                                                                    <a href="{{ url_for('download_order_pdf', order_id=order.get('order_id', '')) }}" 
                                                                       class="btn btn-outline-secondary btn-sm download-invoice" 
                                                                       target="_blank">
                                                                            <i class="fa fa-download"></i> Download Invoice
                                                                        </a>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="5" class="text-center">No returned items found.</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script>
    function validateName() {
        const nameInput = document.getElementById('f-name');
        // Replace any character that is not a letter or space with an empty string
        nameInput.value = nameInput.value.replace(/[^A-Za-z\s]/g, '');

        // Display error if any invalid character is entered
        const regex = /^[A-Za-z\s]+$/;
        if (!regex.test(nameInput.value)) {
            document.getElementById('nameError').innerText = 'Name can only contain letters and spaces.';
            return false;
        } else {
            document.getElementById('nameError').innerText = '';
            return true;
        }
    }

    function validateDistrict() {
        const districtInput = document.getElementById('l-name');
        // Replace any character that is not a letter or space with an empty string
        districtInput.value = districtInput.value.replace(/[^A-Za-z\s]/g, '');

        // Display error if any invalid character is entered
        const regex = /^[A-Za-z\s]+$/;
        if (!regex.test(districtInput.value) || districtInput.value.trim() === '') {
            document.getElementById('districtError').innerText = 'Address can only contain letters and spaces.';
            return false;
        } else {
            document.getElementById('districtError').innerText = '';
            return true;
        }
    }

    function validatePhone() {
        const phoneInput = document.getElementById('phone');
        // Replace any character that is not a digit with an empty string
        phoneInput.value = phoneInput.value.replace(/[^0-9]/g, '');

        // Display error if any invalid character is entered
        const regex = /^[0-9]{10}$/;
        if (!regex.test(phoneInput.value)) {
            document.getElementById('phoneError').innerText = 'Phone number must be 10 digits.';
            return false;
        } else {
            document.getElementById('phoneError').innerText = '';
            return true;
        }
    }

    function validateAddress() {
        const address = document.getElementById('address');
        const addressError = document.getElementById('addressError');
        const addressValue = address.value.trim();
        
        // Regular expression to allow only letters, numbers, spaces, commas, periods, and newlines
        const validAddressPattern = /^[a-zA-Z0-9\s,.'"\n]+$/;
        
        if (!addressValue) {
            addressError.textContent = 'Please enter your address';
            return false;
        } else if (addressValue.length < 10) {
            addressError.textContent = 'Address should be at least 10 characters long';
            return false;
        } else if (!validAddressPattern.test(addressValue)) {
            addressError.textContent = 'Address can only contain letters, numbers, spaces, commas, and periods';
            address.value = addressValue.replace(/[^a-zA-Z0-9\s,.'"\n]/g, '');
            return false;
        } else {
            addressError.textContent = '';
            return true;
        }
    }

    function validateForm() {
        const isNameValid = validateName();
        const isDistrictValid = validateDistrict();
        const isPhoneValid = validatePhone();
        const isAddressValid = validateAddress();
        
        return isNameValid && isDistrictValid && isPhoneValid && isAddressValid;
    }
</script>
                    
                </div>
            </div>
        </div>
        <!-- My Account Page End Here -->
        <!-- Brand Logo Start -->
        <div class="brand-area pb-60">
            <div class="container">
                <!-- Brand Banner Start -->
                <div class="brand-banner owl-carousel">
                    <div class="single-brand">
                        <a href="#"><img class="img" src="{{ url_for('static', filename='img/brand/1.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/2.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/3.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/4.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/5.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img class="img" src="{{ url_for('static', filename='img/brand/1.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/2.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/3.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/4.png') }}" alt="brand-image"></a>
                    </div>
                    <div class="single-brand">
                        <a href="#"><img src="{{ url_for('static', filename='img/brand/5.png') }}" alt="brand-image"></a>
                    </div>
                </div>
                <!-- Brand Banner End -->                
            </div>
            
        </div>
        <!-- Brand Logo End -->

        <footer class="off-white-bg">
            <!-- Footer Top Start -->
            <div class="footer-top pt-50 pb-60">
                <div class="container">
                                  
                    <div class="row">
                        <!-- Single Footer Start -->
                        <div class="col-lg-4  col-md-7 col-sm-6">
                            <div class="single-footer">
                                <h3>Contact us</h3>
                                <div class="footer-content">
                                    <div class="loc-address">
                                        <span><i class="fa fa-map-marker"></i>Toolhive Building Y Road.</span>
                                        <span><i class="fa fa-envelope-o"></i>toolhive@gmail.com</span>
                                        <span><i class="fa fa-phone"></i>Phone: 9877665544</span>
                                    </div>
                                    <img class="img" src="{{ url_for('static', filename='img/footer/1.png') }}" alt="payment-image">
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                        <!-- Single Footer Start -->
                        <div class="col-lg-2  col-md-5 col-sm-6 footer-full">
                            <div class="single-footer">
                                <h3 class="footer-title">Information</h3>
                                <div class="footer-content">
                                    <ul class="footer-list">
                                        <li><a href="#">Site Map</a></li>
                                        <li><a href="#">Specials</a></li>
                                        <li><a href="#">Jobs</a></li>
                                        <li><a href="#">Delivery Information</a></li>
                                        <li><a href="#">Order History</a></li>
                                        <li><a href="#">Privacy Policy</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                        <!-- Single Footer Start -->
                        <div class="col-lg-2  col-md-4 col-md-4 col-sm-6 footer-full">
                            <div class="single-footer">
                                <h3 class="footer-title">My Account</h3>
                                <div class="footer-content">
                                    <ul class="footer-list">
                                        <li><a href="account.html">My account</a></li>
                                        <li><a href="#">Checkout</a></li>
                                        <li><a href="#">Login</a></li>
                                        <li><a href="#">address</a></li>
                                        <li><a href="#">Order status</a></li>
                                        <li><a href="#">Site Map</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                        <!-- Single Footer Start -->
                        <div class="col-lg-2 col-md-4 col-sm-6 footer-full">
                            <div class="single-footer">
                                <h3 class="footer-title">customer service</h3>
                                <div class="footer-content">
                                    <ul class="footer-list">
                                        <li><a href="account.html">My account</a></li>
                                        <li><a href="#">New</a></li>
                                        <li><a href="#">Gift Cards</a></li>
                                        <li><a href="#">Return Policy</a></li>
                                        <li><a href="#">Your Orders</a></li>
                                        <li><a href="#">Subway</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                        <!-- Single Footer Start -->
                        <div class="col-lg-2 col-md-4 col-sm-6 footer-full">
                            <div class="single-footer">
                                <h3 class="footer-title">Let Us Help You</h3>
                                <div class="footer-content">
                                    <ul class="footer-list">
                                        <li><a href="#">Your Account</a></li>
                                        <li><a href="#">Your Orders</a></li>
                                        <li><a href="#">Shipping</a></li>
                                        <li><a href="#">Amazon Prime</a></li>
                                        <li><a href="#">Replacements</a></li>
                                        <li><a href="#">Manage </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Single Footer Start -->
                    </div>
                    <!-- Row End -->
                </div>
                <!-- Container End -->
            </div>
            <!-- Footer Top End -->
            <!-- Footer Bottom Start -->
            <div class="footer-bottom off-white-bg2">
                <div class="container">
                    <div class="footer-bottom-content">
                        
                        <div class="footer-social-content">
                            <ul class="social-content-list">
                                <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                                <li><a href="#"><i class="fa fa-wifi"></i></a></li>
                                <li><a href="#"><i class="fa fa-google-plus"></i></a></li>
                                <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                                <li><a href="#"><i class="fa fa-youtube"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Container End -->
            </div>
            <!-- Footer Bottom End -->
        </footer>
        <!-- Footer End -->
    </div>
    <!-- Wrapper End -->
    <!-- jquery 3.12.4 -->
    <script src="{{ url_for('static', filename='js/vendor/jquery-1.12.4.min.js') }}"></script>
<!-- mobile menu js  -->
<script src="{{ url_for('static', filename='js/jquery.meanmenu.min.js') }}"></script>
<!-- scroll-up js -->
<script src="{{ url_for('static', filename='js/jquery.scrollUp.js') }}"></script>
<!-- owl-carousel js -->
<script src="{{ url_for('static', filename='js/owl.carousel.min.js') }}"></script>
<!-- slick js -->
<script src="{{ url_for('static', filename='js/slick.min.js') }}"></script>
<!-- wow js -->
<script src="{{ url_for('static', filename='js/wow.min.js') }}"></script>
<!-- price slider js -->
<script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.countdown.min.js') }}"></script>
<!-- nivo slider js -->
<script src="{{ url_for('static', filename='js/jquery.nivo.slider.js') }}"></script>
<!-- fancybox js -->
<script src="{{ url_for('static', filename='js/jquery.fancybox.min.js') }}"></script>
<!-- bootstrap -->
<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
<!-- plugins -->
<script src="{{ url_for('static', filename='js/plugins.js') }}"></script>
<!-- main js -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

<!-- Remove all other jQuery and Bootstrap imports and keep only these -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Initialize Firebase -->
<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB42nHmPcpj7BmOPPdO93lXqzA3PjjXZOc",
        authDomain: "project-dbebd.firebaseapp.com",
        databaseURL: "https://project-dbebd-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "project-dbebd",
        storageBucket: "project-dbebd.appspot.com",
        messagingSenderId: "374516311348",
        appId: "1:374516311348:web:d916facf6720a4e275f161"
    };

    // Initialize Firebase app if it hasn't been initialized yet
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    } else {
        firebase.app(); // if already initialized, use that one
    }

    // Get database reference - make it global
    window.database = firebase.database();
</script>

<!-- Include the rental extension script AFTER Firebase and Bootstrap -->
<script src="{{ url_for('static', filename='js/rental-extension.js') }}"></script>

<!-- Include the order details script -->
<script src="{{ url_for('static', filename='js/order-details.js') }}"></script>

<!-- Add the return functionality JavaScript -->
<script>
$(document).ready(function() {
    // All modal initialization and event handlers for moreDetailsModal have been removed
    // The modal is now fully handled by order-details.js
    
    // Close button handlers for both the X and footer close button
    $('[data-bs-dismiss="modal"]').on('click', function() {
        $('#moreDetailsModal').modal('hide');
    });

    // Modal hidden event handler for cleanup
    $('#moreDetailsModal').on('hidden.bs.modal', function() {
        $('#moreDetailsContent').empty().addClass('d-none');
        $('#orderDetailsLoading').removeClass('d-none');
        $('#orderDetailsError').addClass('d-none');
    });

    // Use consistent class name
    $('.return-btn, .return-item').on('click', function(e) {
        e.preventDefault();
        const orderId = $(this).data('order-id');
        const productId = $(this).data('product-id');  // Get product_id
        const productName = $(this).data('product-name');
        const rentFrom = $(this).data('rent-from');
        const rentTo = $(this).data('rent-to');
        const quantity = $(this).data('quantity') || 1;

        console.log('Return button clicked:', { orderId, productId, productName, rentFrom, rentTo, quantity });

        // Update modal content
        $('#returnProductName').text(productName);
        $('#returnRentFrom').text(rentFrom);
        $('#returnRentTo').text(rentTo);
        
        // Add quantity information to the modal
        if (quantity > 1) {
            $('#returnQuantityInfo').show().find('span').text(quantity);
        } else {
            $('#returnQuantityInfo').hide();
        }
        
        // Store both orderId and productId for the confirm action
        $('#confirmReturn')
            .data('order-id', orderId)
            .data('product-id', productId);

        // Use Bootstrap 5 modal initialization
        const returnModal = document.getElementById('confirmReturnModal');
        const bsReturnModal = new bootstrap.Modal(returnModal);
        bsReturnModal.show();
    });

    // Update the confirm return handler
    $('#confirmReturn').on('click', function() {
        const orderId = $(this).data('order-id');
        const productId = $(this).data('product-id');

        console.log('Confirming return:', { orderId, productId });

        $.ajax({
            url: '/initiate-return',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                order_id: orderId,
                product_id: productId
            }),
            success: function(response) {
                // Use Bootstrap 5 modal hide
                const returnModal = document.getElementById('confirmReturnModal');
                const bsReturnModal = bootstrap.Modal.getInstance(returnModal);
                if (bsReturnModal) {
                    bsReturnModal.hide();
                }
                // Remove alert and just reload
                setTimeout(() => {
                    location.reload();
                }, 500);
            },
            error: function(xhr, status, error) {
                console.error('Return error:', error);
                // Changed the error alert message too
            }
        });
    });

    // Add showToast function
    function showToast(title, message, isError = false) {
        const toast = document.getElementById('liveToast');
        const toastInstance = new bootstrap.Toast(toast);
        
        // Set toast content
        document.getElementById('toastTitle').textContent = title;
        document.getElementById('toastMessage').textContent = message;
        
        // Set toast class based on type
        toast.classList.remove('bg-danger', 'text-white', 'bg-success');
        if (isError) {
            toast.classList.add('bg-danger', 'text-white');
        } else {
            toast.classList.add('bg-success', 'text-white');
        }
        
        // Show toast
        toastInstance.show();
    }

    // Update the success handling in your existing script
    // Confirm cancel button handler
    $('#confirmCancel').on('click', function() {
        const orderId = $('#cancelOrderId').text();
        const button = $(this);
        
        // Show loading state
        $('#cancelOrderContent').addClass('d-none');
        $('#cancelOrderLoading').removeClass('d-none');
        $('#cancelOrderError').addClass('d-none');
        button.prop('disabled', true);

        // Send cancel request
        $.ajax({
            url: '/cancel-order',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ order_id: orderId }),
            success: function(response) {
                console.log('Cancel response:', response);
                if (response.success) {
                    cancelOrderModal.hide();
                    showToast('Success', 'Order cancelled successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    $('#cancelOrderLoading').addClass('d-none');
                    $('#cancelOrderError').removeClass('d-none')
                        .text(response.error || 'Failed to cancel order');
                    $('#cancelOrderContent').removeClass('d-none');
                    showToast('Error', response.error || 'Failed to cancel order', true);
                }
            },
            error: function(xhr, status, error) {
                console.error('Cancel error:', error);
                $('#cancelOrderLoading').addClass('d-none');
                $('#cancelOrderError').removeClass('d-none');
                $('#cancelOrderContent').removeClass('d-none');
                showToast('Error', 'Failed to cancel order. Please try again.', true);
            },
            complete: function() {
                button.prop('disabled', false);
            }
        });
    });

    // Add this function to generate and download the invoice
    function downloadInvoice(orderId) {
        // Get the order details from the modal
        const orderDetails = {
            orderId: orderId,
            storeName: $('#moreDetailsContent').find('.store-name').text(),
            gstNumber: $('#moreDetailsContent').find('.gst-number').text(),
            items: [],
            total: $('#moreDetailsContent').find('p:contains("Total")').text().split('₹')[1]
        };

        // Collect all items and their statuses
        $('#moreDetailsContent .list-group-item').each(function() {
            const item = {
                name: $(this).find('strong').text(),
                status: $(this).find('.badge').text(),
                quantity: $(this).text().match(/Quantity: (\d+)/)[1],
                price: $(this).text().match(/Price: ₹([\d.]+)/)[1],
                rentFrom: $(this).text().match(/Rent From: ([\d/]+)/)[1],
                rentTo: $(this).text().match(/Rent To: ([\d/]+)/)[1],
                storeName: $(this).find('.text-muted').text().replace('Store: ', '')
            };
            orderDetails.items.push(item);
        });

        // Send to server to generate PDF
        $.ajax({
            url: '/generate-invoice',
            method: 'POST',
            data: JSON.stringify(orderDetails),
            contentType: 'application/json',
            success: function(response) {
                // Create a blob from the PDF data
                const blob = new Blob([response], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice_${orderId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
            error: function(xhr, status, error) {
                showToast('Error', 'Failed to generate invoice', true);
            }
        });
    }

    function updateCancelButton(button, orderTime, cancelWindowMs, orderStatus) {
        const now = new Date();
        const timeSinceOrder = now - orderTime;
        const timeLeftMs = cancelWindowMs - timeSinceOrder;
        const orderId = button.data('order-id');

        if (timeLeftMs <= 0 || orderStatus.toLowerCase() === 'cancelled') {
            button.hide();
            $(`#download-invoice-${orderId}`).hide();
            if (orderStatus === 'paid') {
                $(`#return-button-${orderId}`).show();
            }
            updateEditOrderButtonVisibility(orderId);
            return;
        }

        const minutes = Math.floor(timeLeftMs / 60000);
        const seconds = Math.floor((timeLeftMs % 60000) / 1000);

        button.text(`Cancel Order (${minutes}:${seconds.toString().padStart(2, '0')})`);
        button.show();
        $(`#return-button-${orderId}`).hide();

        // Store the timer in a global variable
        window[`cancelTimer_${orderId}`] = setTimeout(() => {
            button.hide();
            updateEditOrderButtonVisibility(orderId);
            showToast('Info', `Cancellation window for Order #${orderId} has ended.`, false);
        }, timeLeftMs);
    }

    function updateEditOrderButtonVisibility(orderId) {
        const cancelButton = $(`#cancel-button-${orderId}`);
        const editButton = $(`.edit-order[data-order-id="${orderId}"]`);
        
        if (cancelButton.is(':visible')) {
            editButton.show();
        } else {
            editButton.hide();
        }
    }

    // Make sure to call updateCancelButton for each order when the page loads
    $('.cancel-order').each(function() {
        const button = $(this);
        const orderId = button.data('order-id');
        const orderTime = new Date(button.data('order-time'));
        const cancelWindowMs = 10 * 60 * 1000; // 10 minutes in milliseconds
        const orderStatus = button.data('order-status');
        
        updateCancelButton(button, orderTime, cancelWindowMs, orderStatus);
    });

    $('.cancel-order').on('click', function() {
        const orderId = $(this).data('order-id');
        const productName = $(this).data('product-name');
        const orderTime = new Date($(this).data('order-time'));
        const cancelWindowMs = 10 * 60 * 1000; // 10 minutes in milliseconds
        const now = new Date();
        const timeSinceOrder = now - orderTime;

        if (timeSinceOrder <= cancelWindowMs) {
            $('#cancelOrderId').text(orderId);
            $('#cancelProductName').text(productName);
            
            // Use Bootstrap 5 modal initialization
            const cancelOrderModal = document.getElementById('cancelOrderModal');
            const bsCancelOrderModal = new bootstrap.Modal(cancelOrderModal);
            bsCancelOrderModal.show();
        } else {
            showToast('Error', 'The cancellation window for this order has expired.', true);
        }
    });

    // Reset modal on close - use Bootstrap 5 event
    document.getElementById('cancelOrderModal').addEventListener('hidden.bs.modal', function() {
        $('#cancelOrderContent').removeClass('d-none');
        $('#cancelOrderLoading').addClass('d-none');
        $('#cancelOrderError').addClass('d-none');
        $('#cancelOrderId').text('');
        $('#cancelProductName').text('');
    });

    // Check if orders can be cancelled (within 10 minutes of ordering)
    $('.cancel-item').each(function() {
        const orderTimeStr = $(this).data('order-time');
        const statusCell = $(this).closest('tr').find('[id^="status-cell-"]');
        const isPartial = statusCell.find('.badge').text().includes('Partially Cancelled');
        
        if (orderTimeStr) {
            const orderTime = new Date(orderTimeStr);
            const currentTime = new Date();
            const timeDiffMinutes = (currentTime - orderTime) / (1000 * 60);
            
            // If more than 10 minutes have passed, hide the cancel button
            // Unless it's a partially cancelled item which can still be cancelled
            if (timeDiffMinutes > 10 && !isPartial) {
                $(this).hide();
            }
        }
    });

    // Add this to your existing JavaScript
    $('.cancel-item').on('click', function() {
        const orderId = $(this).data('order-id');
        const productId = $(this).data('product-id');
        const productName = $(this).data('product-name');
        const quantity = parseInt($(this).data('quantity') || 1);

        // Populate modal
        $('#cancelItemOrderId').text(orderId);
        $('#cancelItemProductName').text(productName);
        
        // Store product ID in a hidden field
        if (!$('#cancelItemProductId').length) {
            $('<input>').attr({
                type: 'hidden',
                id: 'cancelItemProductId',
                value: productId
            }).appendTo('#cancelItemModal .modal-body');
        } else {
            $('#cancelItemProductId').val(productId);
        }
        
        // Populate quantity selector if quantity > 1
        const $quantitySelector = $('#cancelQuantitySelector');
        const $cancelQuantity = $('#cancelQuantity');
        
        $cancelQuantity.empty();
        
        if (quantity > 1) {
            // Show quantity selector and populate options
            $quantitySelector.show();
            
            for (let i = 1; i <= quantity; i++) {
                $cancelQuantity.append(`<option value="${i}">${i}</option>`);
            }
        } else {
            // Hide quantity selector for single items
            $quantitySelector.hide();
        }
        
        // Show the modal using Bootstrap 5
        const modal = new bootstrap.Modal(document.getElementById('cancelItemModal'));
        modal.show();
    });

    // Handle the confirm cancel button click
    $('#confirmCancelItem').on('click', function() {
        const orderId = $('#cancelItemOrderId').text();
        const productId = $('#cancelItemProductId').val() || '';
        const productName = $('#cancelItemProductName').text();
        const cancelQuantity = parseInt($('#cancelQuantity').val() || 1);
        const button = $(this);
        
        // Show loading state
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
        
        // Send the cancel request to the server
        $.ajax({
            url: '/cancel-order-item',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                order_id: orderId,
                product_id: productId,
                quantity: cancelQuantity
            }),
            success: function(response) {
                // Hide the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('cancelItemModal'));
                modal.hide();
                
                if (response.success) {
                    // Show success message
                    showToast('Success', 'Item cancelled successfully');
                    
                    // Show refund notification popup
                    $('#refundNotification').fadeIn(300).delay(5000).fadeOut(300);
                    
                    // Update the UI to reflect the cancellation
                    const itemRow = $(`#item-row-${orderId}-${productId}`);
                    if (itemRow.length) {
                        // If partially cancelled or full item cancellation
                        if (response.status === 'partially_cancelled') {
                            // Update the status cell to show partially cancelled status
                            $(`#status-cell-${orderId}-${productId}`).html(`
                                <span class="badge bg-warning text-dark">Partially Cancelled</span><br>
                                <small>Cancelled: ${response.cancelled_quantity || 'N/A'}, Remaining: ${response.quantity || 'N/A'}</small><br>
                                <small>Rental Period: ${response.rent_from || 'N/A'} to ${response.rent_to || 'N/A'}</small><br>
                                <small>Quantity: ${response.quantity || 'N/A'} | Days: ${response.rental_days || 'N/A'}</small>
                            `);
                            
                            // Update the displayed quantity
                            $(`#item-quantity-${orderId}-${productId}`).text(response.quantity);
                            
                            // Update item price display if available
                            if (response.item_price !== undefined) {
                                const priceCell = itemRow.find('td:nth-child(3)');
                                priceCell.text(`₹${parseFloat(response.item_price).toFixed(2)}`);
                            }
                            
                            // Update the cancel button with new quantity and text
                            const cancelButton = $(`#cancel-button-${orderId}-${productId}`);
                            cancelButton.data('quantity', response.quantity);
                            cancelButton.html(`<i class="fa fa-times"></i> Cancel Remaining`);
                        } else {
                            // Fully cancelled
                            $(`#status-cell-${orderId}-${productId}`).html(`
                                <span class="badge bg-danger">Cancelled</span><br>
                                <small>Rental Period: ${response.rent_from || 'N/A'} to ${response.rent_to || 'N/A'}</small><br>
                                <small>Quantity: ${response.quantity || 'N/A'} | Days: ${response.rental_days || 'N/A'}</small>
                            `);
                            
                            // Update price display to show 0 for cancelled items
                            itemRow.find('td:nth-child(3)').text(`₹0.00`);
                            
                            // Hide the cancel button for fully cancelled items
                            $(`#cancel-button-${orderId}-${productId}`).hide();
                        }
                        
                        // Update order total if provided in the response
                        if (response.subtotal !== undefined) {
                            $(`#order-total-${orderId}`).text(`₹${parseFloat(response.subtotal).toFixed(2)}`);
                        }
                    }
                } else {
                    // Show error message
                    showToast('Error', response.message || 'Failed to cancel item', true);
                }
            },
            error: function(xhr, status, error) {
                // Hide the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('cancelItemModal'));
                modal.hide();
                
                // Show error message
                showToast('Error', 'Cancel error: ' + (xhr.responseJSON?.message || error), true);
                console.error('Cancel error:', error);
            },
            complete: function() {
                // Reset button state
                button.prop('disabled', false).html('Yes, Cancel Item');
            }
        });
    });

    // Check if Bootstrap is loaded
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded!');
        alert('Error: Bootstrap is not loaded. Please check your internet connection and reload the page.');
        return;
    } else {
        console.log('Bootstrap version:', bootstrap.Tooltip.VERSION);
    }

    // Prevent download invoice buttons from appearing in order details modal when accessed from orders tab
    $('.view-order-details').on('click', function() {
        const orderId = $(this).data('order-id');
        
        // Get order details
        $.ajax({
            url: `/order-details/${orderId}`,
            method: 'GET',
            success: function(response) {
                // Process the response
                if (response.success) {
                    $('#orderDetailsLoading').addClass('d-none');
                    
                    // Create content without download invoice buttons for orders tab
                    const orderContent = `
                        <!-- Order info content -->
                        <div class="order-info mb-4">
                            <h6>Order Information</h6>
                            <p><strong>Order ID:</strong> ${response.order_id}</p>
                            <p><strong>Total Price:</strong> ₹${parseFloat(response.subtotal).toFixed(2)}</p>
                            <p><strong>Order Date:</strong> ${response.created_at}</p>
                        </div>
                        
                        <!-- Items list without download buttons -->
                        <div class="order-items mb-4">
                            <h6>Ordered Items</h6>
                            <div class="list-group">
                                ${response.items.map(item => `
                                    <!-- Item content without download buttons -->
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                    $('#moreDetailsContent').html(orderContent).removeClass('d-none');
                } else {
                    $('#orderDetailsError').removeClass('d-none');
                }
            },
            error: function() {
                $('#orderDetailsLoading').addClass('d-none');
                $('#orderDetailsError').removeClass('d-none');
            }
        });
    });
    
    // Make sure the downloadInvoice function only works from the Returns tab
    $('.download-invoice').on('click', function(e) {
        // Only allow download if we're in the Returns tab
        if (!$('#returns').hasClass('active') && !$(this).closest('#returns').length) {
            e.preventDefault();
            return false;
        }
    });
});
</script>

<!-- Add complete modal structure -->
<div class="modal fade" id="confirmReturnModal" tabindex="-1" aria-labelledby="confirmReturnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReturnModalLabel">Confirm Return</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to return this item?</p>
                <p><strong>Product:</strong> <span id="returnProductName"></span></p>
                <div id="returnQuantityInfo">
                    <p><strong>Quantity:</strong> <span>1</span> <small class="text-muted">(All units will be returned together)</small></p>
                </div>
                <p><strong>Rent From:</strong> <span id="returnRentFrom"></span></p>
                <p><strong>Rent To:</strong> <span id="returnRentTo"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmReturn">Confirm Return</button>
            </div>
        </div>
    </div>
</div>

<!-- More Details Modal -->
<div class="modal fade" id="moreDetailsModal" tabindex="-1" aria-labelledby="moreDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moreDetailsModalLabel">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading Spinner -->
                <div id="orderDetailsLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Error Alert -->
                <div id="orderDetailsError" class="alert alert-danger d-none" role="alert">
                    Failed to load order details. Please try again.
                </div>

                <!-- Order Content -->
                <div id="moreDetailsContent" class="d-none">
                    <!-- Content will be dynamically populated without download buttons -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <!-- No download button here -->
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelOrderModalLabel">Cancel Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading Spinner -->
                <div id="cancelOrderLoading" class="text-center py-4 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Error Alert -->
                <div id="cancelOrderError" class="alert alert-danger d-none" role="alert">
                    Failed to process cancellation. Please try again.
                </div>

                <!-- Cancel Content -->
                <div id="cancelOrderContent">
                    <p>Are you sure you want to cancel this order?</p>
                    <p><strong>Order ID:</strong> <span id="cancelOrderId"></span></p>
                    <p><strong>Product:</strong> <span id="cancelProductName"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep Order</button>
                <button type="button" class="btn btn-danger" id="confirmCancel">Yes, Cancel Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this modal for item cancellation -->
<div class="modal fade" id="cancelItemModal" tabindex="-1" aria-labelledby="cancelItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelItemModalLabel">Cancel Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this item?</p>
                <p><strong>Order ID:</strong> <span id="cancelItemOrderId"></span></p>
                <p><strong>Product:</strong> <span id="cancelItemProductName"></span></p>
                <div id="cancelQuantitySelector" class="mt-3">
                    <label for="cancelQuantity" class="form-label">Select quantity to cancel:</label>
                    <select id="cancelQuantity" class="form-select">
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep Item</button>
                <button type="button" class="btn btn-danger" id="confirmCancelItem">Yes, Cancel Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Refund Notification Popup -->
<div id="refundNotification" class="position-fixed top-50 start-50 translate-middle bg-white p-4 rounded shadow-lg text-center" style="display: none; z-index: 9999;">
    <div class="mb-3">
        <i class="fa fa-check-circle text-success" style="font-size: 48px;"></i>
    </div>
    <h4>Refund Initiated</h4>
    <p>Your wallet deposit and paid amount will be refunded soon.</p>
    <p class="text-muted small">The refund process typically takes 3-5 business days.</p>
</div>

<!-- Add Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>

<!-- Extend Rental Modal -->
<div class="modal fade" id="extendRentalModal" tabindex="-1" aria-labelledby="extendRentalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="extendRentalModalLabel">Extend Rental Period</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="extendRentalContent">
                    <input type="hidden" id="extendOrderId">
                    <input type="hidden" id="extendItemIndex">
                    <input type="hidden" id="maxDays">
                    <input type="hidden" id="perDayCharge">
                    
                    <div class="mb-3">
                        <label class="form-label">Current Return Date</label>
                        <input type="text" class="form-control" id="currentRentTo" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Available Deposit Amount</label>
                        <input type="text" class="form-control" id="availableDeposit" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Number of Days to Extend</label>
                        <select class="form-select" id="extensionDays">
                            <option value="">Select days</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Total Extension Cost</label>
                        <input type="text" class="form-control" id="extensionCost" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Remaining Deposit After Extension</label>
                        <input type="text" class="form-control" id="remainingDeposit" readonly>
                    </div>
                </div>
                
                <div id="extendRentalLoading" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing your request...</p>
                </div>
                
                <div id="extendRentalError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitExtensionBtn">Extend Rental</button>
            </div>
        </div>
    </div>
</div>

<!-- Wallet Modal -->
<div class="modal fade" id="walletModal" tabindex="-1" aria-labelledby="walletModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="walletModalLabel">Wallet Balance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fa fa-wallet fa-3x mb-3" style="color: #ff6a00;"></i>
                <h3>Current Balance</h3>
                <h2 class="text-primary">₹{{ "%.2f"|format(wallet_balance|default(0)) }}</h2>
                <p class="text-muted mt-2">Total refundable deposit amount from all your orders</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .modal-header {
        border-bottom: none;
        padding: 20px 25px;
    }
    
    .modal-body {
        padding: 30px;
    }
    
    .modal-footer {
        border-top: none;
        padding: 20px 25px;
    }
    
    .btn-secondary {
        background-color: #ff6a00;
        border: none;
    }
    
    .btn-secondary:hover {
        background-color: #e55d00;
    }
</style>
</body>
</html>